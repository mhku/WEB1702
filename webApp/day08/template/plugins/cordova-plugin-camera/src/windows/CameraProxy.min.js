var Camera=require("./Camera");var getAppData=function(){return Windows.Storage.ApplicationData.current};var encodeToBase64String=function(a){return Windows.Security.Cryptography.CryptographicBuffer.encodeToBase64String(a)};var OptUnique=Windows.Storage.CreationCollisionOption.generateUniqueName;var CapMSType=Windows.Media.Capture.MediaStreamType;var webUIApp=Windows.UI.WebUI.WebUIApplication;var fileIO=Windows.Storage.FileIO;var pickerLocId=Windows.Storage.Pickers.PickerLocationId;module.exports={takePicture:function(a,b,c){var d=c[2];if(d!=Camera.PictureSourceType.CAMERA){takePictureFromFile(a,b,c)}else{takePictureFromCamera(a,b,c)}}};var windowsVideoContainers=[".avi",".flv",".asx",".asf",".mov",".mp4",".mpg",".rm",".srt",".swf",".wmv",".vob"];var windowsPhoneVideoContainers=[".avi",".3gp",".3g2",".wmv",".3gp",".3g2",".mp4",".m4v"];var DEFAULT_ASPECT_RATIO="1.8";var HIGHEST_POSSIBLE_Z_INDEX=2147483647;function resizeImage(b,c,e,d,a,g){var h="";if(g==Camera.EncodingType.PNG){h="camera_cordova_temp_return.png"}else{h="camera_cordova_temp_return.jpg"}var f=getAppData().localFolder;e.copyAsync(f,e.name,Windows.Storage.NameCollisionOption.replaceExisting).then(function(i){return fileIO.readBufferAsync(i)}).then(function(j){var i=encodeToBase64String(j);var l="data:"+e.contentType+";base64,"+i;var k=new Image();k.src=l;k.onload=function(){var p=Math.min(d/this.width,a/this.height);var n=p*this.width;var m=p*this.height;var o=document.createElement("canvas");var s;o.width=n;o.height=m;o.getContext("2d").drawImage(this,0,0,n,m);var r=o.toDataURL(e.contentType).split(",")[1];var q=getAppData().localFolder;q.createFileAsync(h,OptUnique).then(function(u){var t=Windows.Security.Cryptography.CryptographicBuffer.decodeFromBase64String(r);s=u.name;return fileIO.writeBufferAsync(u,t)}).done(function(){b("ms-appdata:///local/"+s)},c)}}).done(null,function(i){c(i)})}function resizeImageBase64(b,c,e,d,a){fileIO.readBufferAsync(e).done(function(g){var f=encodeToBase64String(g);var i="data:"+e.contentType+";base64,"+f;var h=new Image();h.src=i;h.onload=function(){var p=Math.min(d/this.width,a/this.height);var m=p*this.width;var k=p*this.height;var o=document.createElement("canvas");o.width=m;o.height=k;var l=o.getContext("2d");l.drawImage(this,0,0,m,k);var q=o.toDataURL(e.contentType);var j=q.split(",");var n=q.substr(j[0].length+1);b(n)}},function(f){c(f)})}function takePictureFromFile(a,b,c){if(navigator.appVersion.indexOf("Windows Phone 8.1")>=0){takePictureFromFileWP(a,b,c)}else{takePictureFromFileWindows(a,b,c)}}function takePictureFromFileWP(c,e,h){var j=h[6],g=h[1],i=h[3],f=h[4],b=h[5];var a=function(k){if(k.kind===Windows.ApplicationModel.Activation.ActivationKind.pickFileContinuation){var l=k.files[0];if(!l){e("User didn't choose a file.");webUIApp.removeEventListener("activated",a);return}if(g==Camera.DestinationType.FILE_URI||g==Camera.DestinationType.NATIVE_URI){if(f>0&&i>0){resizeImage(c,e,l,i,f,b)}else{var m=getAppData().localFolder;l.copyAsync(m,l.name,Windows.Storage.NameCollisionOption.replaceExisting).done(function(n){if(g==Camera.DestinationType.NATIVE_URI){c("ms-appdata:///local/"+n.name)}else{c(URL.createObjectURL(n))}},function(){e("Can't access localStorage folder.")})}}else{if(f>0&&i>0){resizeImageBase64(c,e,l,i,f)}else{fileIO.readBufferAsync(l).done(function(o){var n=encodeToBase64String(o);c(n)},e)}}webUIApp.removeEventListener("activated",a)}};var d=new Windows.Storage.Pickers.FileOpenPicker();if(j==Camera.MediaType.PICTURE){d.fileTypeFilter.replaceAll([".png",".jpg",".jpeg"]);d.suggestedStartLocation=pickerLocId.picturesLibrary}else{if(j==Camera.MediaType.VIDEO){d.fileTypeFilter.replaceAll(windowsPhoneVideoContainers);d.suggestedStartLocation=pickerLocId.videosLibrary}else{d.fileTypeFilter.replaceAll(["*"]);d.suggestedStartLocation=pickerLocId.documentsLibrary}}webUIApp.addEventListener("activated",a);d.pickSingleFileAndContinue()}function takePictureFromFileWindows(b,d,g){var i=g[6],f=g[1],h=g[3],e=g[4],a=g[5];var c=new Windows.Storage.Pickers.FileOpenPicker();if(i==Camera.MediaType.PICTURE){c.fileTypeFilter.replaceAll([".png",".jpg",".jpeg"]);c.suggestedStartLocation=pickerLocId.picturesLibrary}else{if(i==Camera.MediaType.VIDEO){c.fileTypeFilter.replaceAll(windowsVideoContainers);c.suggestedStartLocation=pickerLocId.videosLibrary}else{c.fileTypeFilter.replaceAll(["*"]);c.suggestedStartLocation=pickerLocId.documentsLibrary}}c.pickSingleFileAsync().done(function(j){if(!j){d("User didn't choose a file.");return}if(f==Camera.DestinationType.FILE_URI||f==Camera.DestinationType.NATIVE_URI){if(e>0&&h>0){resizeImage(b,d,j,h,e,a)}else{var k=getAppData().localFolder;j.copyAsync(k,j.name,Windows.Storage.NameCollisionOption.replaceExisting).done(function(l){if(f==Camera.DestinationType.NATIVE_URI){b("ms-appdata:///local/"+l.name)}else{b(URL.createObjectURL(l))}},function(){d("Can't access localStorage folder.")})}}else{if(e>0&&h>0){resizeImageBase64(b,d,j,h,e)}else{fileIO.readBufferAsync(j).done(function(m){var l=encodeToBase64String(m);b(l)},d)}}},function(){d("User didn't choose a file.")})}function takePictureFromCamera(a,b,c){if(!Windows.Media.Capture.CameraCaptureUI){takePictureFromCameraWP(a,b,c)}else{takePictureFromCameraWindows(a,b,c)}}function takePictureFromCameraWP(f,o,e){var j=e[1],l=e[3],m=e[4],C=e[5],b=e[9],y=e[11],d=null,p=null,k=null,x=null,i=null,B=Windows.Media.Capture,z=null;function s(){var D="width:45%;padding: 10px 16px;font-size: 18px;line-height: 1.3333333;color: #333;background-color: #fff;border-color: #ccc; border: 1px solid transparent;border-radius: 6px; display: block; margin: 20px; z-index: 1000;border-color: #adadad;";d=document.createElement("video");d.style.cssText="position: fixed; left: 0; top: 0; width: 100%; height: 100%; z-index: "+(HIGHEST_POSSIBLE_Z_INDEX-1)+";";p=document.createElement("button");p.innerText="Take";p.style.cssText=D+"position: fixed; left: 0; bottom: 0; margin: 20px; z-index: "+HIGHEST_POSSIBLE_Z_INDEX+";";k=document.createElement("button");k.innerText="Cancel";k.style.cssText=D+"position: fixed; right: 0; bottom: 0; margin: 20px; z-index: "+HIGHEST_POSSIBLE_Z_INDEX+";";x=new B.MediaCapture();i=new B.MediaCaptureInitializationSettings();i.streamingCaptureMode=B.StreamingCaptureMode.video}function a(){if(d){d.play()}}function n(){var D=Windows.Devices.Enumeration;var E=y===1?D.Panel.front:D.Panel.back;window.addEventListener("focus",a);D.DeviceInformation.findAllAsync(D.DeviceClass.videoCapture).then(function(F){if(F.length<=0){r();o("Camera not found");return}F.forEach(function(G){if(G.enclosureLocation.panel&&G.enclosureLocation.panel==E){i.videoDeviceId=G.id}});i.photoCaptureSource=Windows.Media.Capture.PhotoCaptureSource.photo;return x.initializeAsync(i)}).then(function(){var F=x.videoDeviceController;var G=F.focusControl;if(G.supported===true){d.addEventListener("click",function(){if(this.getAttribute("clicked")==="1"){return false}else{this.setAttribute("clicked","1")}var J=Windows.Media.Devices.FocusPreset.autoNormal;var I=this;G.setPresetAsync(J).done(function(){I.setAttribute("clicked","0")})})}d.msZoom=true;d.src=URL.createObjectURL(x);d.play();z=Windows.Devices.Sensors.SimpleOrientationSensor.getDefault();if(z!==null){z.addEventListener("orientationchanged",h)}p.addEventListener("click",u);k.addEventListener("click",q);if(z){v(z.getCurrentOrientation())}else{v(Windows.Graphics.Display.DisplayInformation.getForCurrentView().currentOrientation)}var H=t(x);if(H.length===0){r();o("There's not a good aspect ratio available");return}document.body.appendChild(d);document.body.appendChild(p);document.body.appendChild(k);if(H.indexOf(DEFAULT_ASPECT_RATIO)>-1){return w(x,DEFAULT_ASPECT_RATIO)}else{return w(x,H[0])}}).done(null,function(F){r();o("Camera intitialization error "+F)})}function r(){if(z!==null){z.removeEventListener("orientationchanged",h)}d.pause();d.src=null;p.removeEventListener("click",u);k.removeEventListener("click",q);window.removeEventListener("focus",a);[d,p,k].forEach(function(D){if(D){document.body.removeChild(D)}});if(x){x.stopRecordAsync();x=null}}function c(){var D,F,E=getAppData().temporaryFolder;if(C==Camera.EncodingType.PNG){F="photo.png";D=Windows.Media.MediaProperties.ImageEncodingProperties.createPng()}else{F="photo.jpg";D=Windows.Media.MediaProperties.ImageEncodingProperties.createJpeg()}E.createFileAsync(F,OptUnique).then(function(G){return new WinJS.Promise(function(H){var J=new Windows.Storage.Streams.InMemoryRandomAccessStream();var I=new Windows.Storage.Streams.InMemoryRandomAccessStream();x.capturePhotoToStreamAsync(D,J).then(function(){return Windows.Graphics.Imaging.BitmapDecoder.createAsync(J)}).then(function(K){I.size=0;return Windows.Graphics.Imaging.BitmapEncoder.createForTranscodingAsync(I,K)}).then(function(K){K.bitmapTransform.rotation=g(z.getCurrentOrientation());return K.flushAsync()}).then(function(){return G.openAsync(Windows.Storage.FileAccessMode.readWrite)}).then(function(K){return Windows.Storage.Streams.RandomAccessStream.copyAndCloseAsync(I,K)}).done(function(){J.close();I.close();H(G)},function(){J.close();I.close();throw new Error("An error has occured while capturing the photo.")})})}).done(function(G){r();savePhoto(G,{destinationType:j,targetHeight:m,targetWidth:l,encodingType:C,saveToPhotoAlbum:b},f,o)},function(G){r();o(G)})}function t(G){var J=G.videoDeviceController;var D=J.getAvailableMediaStreamProperties(CapMSType.photo).map(function(K){return(K.width/K.height).toFixed(1)}).filter(function(L,K,M){return(K===M.indexOf(L))});var E=J.getAvailableMediaStreamProperties(CapMSType.videoRecord).map(function(K){return(K.width/K.height).toFixed(1)}).filter(function(L,K,M){return(K===M.indexOf(L))});var F=J.getAvailableMediaStreamProperties(CapMSType.videoPreview).map(function(K){return(K.width/K.height).toFixed(1)}).filter(function(L,K,M){return(K===M.indexOf(L))});var I=[].concat(D,E,F);var H=I.reduce(function(L,K){if(!L[K]){L[K]=0}L[K]++;return L},{});return Object.keys(H).filter(function(K){return H[K]===3})}function w(F,E){var I=F.videoDeviceController;var H=I.getAvailableMediaStreamProperties(CapMSType.photo).filter(function(J){return((J.width/J.height).toFixed(1)===E)}).reduce(function(K,J){return(K.width*K.height)>(J.width*J.height)?K:J});var D=I.getAvailableMediaStreamProperties(CapMSType.videoRecord).filter(function(J){return((J.width/J.height).toFixed(1)===E)}).reduce(function(K,J){return(K.width*K.height)>(J.width*J.height)?K:J});var G=I.getAvailableMediaStreamProperties(CapMSType.videoPreview).filter(function(J){return((J.width/J.height).toFixed(1)===E)}).reduce(function(K,J){return(K.width*K.height)>(J.width*J.height)?K:J});return I.setMediaStreamPropertiesAsync(CapMSType.photo,H).then(function(){return I.setMediaStreamPropertiesAsync(CapMSType.videoPreview,G)}).then(function(){return I.setMediaStreamPropertiesAsync(CapMSType.videoRecord,D)})}function u(){if(this.getAttribute("clicked")==="1"){return false}else{this.setAttribute("clicked","1")}c()}function q(){if(this.getAttribute("clicked")==="1"){return false}else{this.setAttribute("clicked","1")}r();o("no image selected")}function h(D){v(D.orientation)}function g(D){switch(D){case Windows.Devices.Sensors.SimpleOrientation.notRotated:return Windows.Media.Capture.VideoRotation.clockwise90Degrees;case Windows.Devices.Sensors.SimpleOrientation.rotated90DegreesCounterclockwise:return Windows.Media.Capture.VideoRotation.none;case Windows.Devices.Sensors.SimpleOrientation.rotated180DegreesCounterclockwise:return Windows.Media.Capture.VideoRotation.clockwise90Degrees;case Windows.Devices.Sensors.SimpleOrientation.rotated270DegreesCounterclockwise:return Windows.Media.Capture.VideoRotation.clockwise180Degrees;default:return Windows.Media.Capture.VideoRotation.clockwise90Degrees}}function v(D){x.setPreviewRotation(g(D))}try{s();n()}catch(A){o(A)}}function takePictureFromCameraWindows(e,h,k){var j=k[1],m=k[3],i=k[4],c=k[5],o=!!k[7],l=k[9],f=Windows.Media.Capture,b=new f.CameraCaptureUI();b.photoSettings.allowCropping=o;if(c==Camera.EncodingType.PNG){b.photoSettings.format=f.CameraCaptureUIPhotoFormat.png}else{b.photoSettings.format=f.CameraCaptureUIPhotoFormat.jpeg}var g=null;var p=f.CameraCaptureUIMaxPhotoResolution;var a=m*i;if(m==-1&&i==-1){g=p.highestAvailable}else{if(a<=640*480){g=p.smallVga}else{if(a<=1024*768){g=p.mediumXga}else{if(a<=3*1000*1000){g=p.large3M}else{if(a<=5*1000*1000){g=p.veryLarge5M}else{g=p.highestAvailable}}}}}b.photoSettings.maxResolution=g;var n;var d=function(){window.removeEventListener("focus",d);savePhoto(n,{destinationType:j,targetHeight:i,targetWidth:m,encodingType:c,saveToPhotoAlbum:l},e,h)};window.addEventListener("focus",d);b.captureFileAsync(f.CameraCaptureUIMode.photo).done(function(q){if(!q){h("User didn't capture a photo.");window.removeEventListener("focus",d);return}n=q},function(){h("Fail to capture a photo.");window.removeEventListener("focus",d)})}function savePhoto(e,c,a,b){var h=function(i){if(c.destinationType==Camera.DestinationType.FILE_URI||c.destinationType==Camera.DestinationType.NATIVE_URI){if(c.targetHeight>0&&c.targetWidth>0){resizeImage(a,b,i,c.targetWidth,c.targetHeight,c.encodingType)}else{i.copyAsync(getAppData().localFolder,i.name,OptUnique).done(function(j){a("ms-appdata:///local/"+j.name)},b)}}else{if(c.targetHeight>0&&c.targetWidth>0){resizeImageBase64(a,b,i,c.targetWidth,c.targetHeight)}else{fileIO.readBufferAsync(i).done(function(k){var j=encodeToBase64String(k);i.deleteAsync().done(function(){a(j)},function(l){b(l)})},b)}}};if(!c.saveToPhotoAlbum){h(e);return}else{var d=new Windows.Storage.Pickers.FileSavePicker();var g=function(i){if(i){Windows.Storage.CachedFileManager.deferUpdates(i);e.moveAndReplaceAsync(i).then(function(){return Windows.Storage.CachedFileManager.completeUpdatesAsync(i)}).done(function(j){if(j===Windows.Storage.Provider.FileUpdateStatus.complete){h(e)}else{b("File update status is not complete.")}},b)}else{b("Failed to select a file.")}};d.suggestedStartLocation=pickerLocId.picturesLibrary;if(c.encodingType===Camera.EncodingType.PNG){d.fileTypeChoices.insert("PNG",[".png"]);d.suggestedFileName="photo.png"}else{d.fileTypeChoices.insert("JPEG",[".jpg"]);d.suggestedFileName="photo.jpg"}if(navigator.appVersion.indexOf("Windows Phone 8.1")>=0){var f=function(i){if(i.kind===Windows.ApplicationModel.Activation.ActivationKind.pickSaveFileContinuation){var j=i.file;g(j);webUIApp.removeEventListener("activated",f)}};webUIApp.addEventListener("activated",f);d.pickSaveFileAndContinue()}else{d.pickSaveFileAsync().done(g,b)}}}require("cordova/exec/proxy").add("Camera",module.exports);