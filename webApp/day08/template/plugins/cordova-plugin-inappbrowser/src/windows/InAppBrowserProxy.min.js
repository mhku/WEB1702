var cordova=require("cordova"),urlutil=require("cordova/urlutil");var browserWrap,popup,navigationButtonsDiv,navigationButtonsDivInner,backButton,forwardButton,closeButton,bodyOverflowStyle,navigationEventsCallback;var isWebViewAvailable=cordova.platformId==="windows";function attachNavigationEvents(a,c){if(isWebViewAvailable){a.addEventListener("MSWebViewNavigationStarting",function(d){c({type:"loadstart",url:d.uri},{keepCallback:true})});a.addEventListener("MSWebViewNavigationCompleted",function(d){if(d.isSuccess){c({type:"loadstop",url:d.uri},{keepCallback:true})}else{c({type:"loaderror",url:d.uri,code:d.webErrorStatus,message:"Navigation failed with error code "+d.webErrorStatus},{keepCallback:true})}});a.addEventListener("MSWebViewUnviewableContentIdentified",function(d){c({type:"loaderror",url:d.uri,code:d.webErrorStatus,message:"Navigation failed with error code "+d.webErrorStatus},{keepCallback:true})});a.addEventListener("MSWebViewContentLoading",function(d){if(navigationButtonsDiv&&popup){if(popup.canGoBack){backButton.removeAttribute("disabled")}else{backButton.setAttribute("disabled","true")}if(popup.canGoForward){forwardButton.removeAttribute("disabled")}else{forwardButton.setAttribute("disabled","true")}}})}else{var b=function(){c({type:"loaderror",url:this.contentWindow.location},{keepCallback:true})};a.addEventListener("unload",function(){c({type:"loadstart",url:this.contentWindow.location},{keepCallback:true})});a.addEventListener("load",function(){c({type:"loadstop",url:this.contentWindow.location},{keepCallback:true})});a.addEventListener("error",b);a.addEventListener("abort",b)}}var IAB={close:function(a,b){setImmediate(function(){if(browserWrap){if(navigationEventsCallback){navigationEventsCallback({type:"exit"})}browserWrap.parentNode.removeChild(browserWrap);document.body.style.msOverflowStyle=bodyOverflowStyle;browserWrap=null;popup=null}})},show:function(a,b){setImmediate(function(){if(browserWrap){browserWrap.style.display="block"}})},open:function(b,c,a){setImmediate(function(){var h=a[0],g=a[1],f=a[2],d;navigationEventsCallback=b;if(g==="_system"){d=new Windows.Foundation.Uri(h);Windows.System.Launcher.launchUriAsync(d)}else{if(g==="_self"||!g){window.location=h}else{if(!browserWrap){var e=document.createElement("link");e.rel="stylesheet";e.type="text/css";e.href=urlutil.makeAbsolute("/www/css/inappbrowser.css");document.head.appendChild(e);browserWrap=document.createElement("div");browserWrap.className="inAppBrowserWrap";if(f.indexOf("fullscreen=yes")>-1){browserWrap.classList.add("inAppBrowserWrapFullscreen")}bodyOverflowStyle=document.body.style.msOverflowStyle;browserWrap.onclick=function(){setTimeout(function(){IAB.close(navigationEventsCallback)},0)};document.body.appendChild(browserWrap);document.body.style.msOverflowStyle="none"}if(f.indexOf("hidden=yes")!==-1){browserWrap.style.display="none"}popup=document.createElement(isWebViewAvailable?"x-ms-webview":"iframe");if(popup instanceof HTMLIFrameElement){popup.style.backgroundColor="white"}popup.style.borderWidth="0px";popup.style.width="100%";browserWrap.appendChild(popup);if(f.indexOf("location=yes")!==-1||f.indexOf("location")===-1){popup.style.height="calc(100% - 70px)";navigationButtonsDiv=document.createElement("div");navigationButtonsDiv.className="inappbrowser-app-bar";navigationButtonsDiv.onclick=function(i){i.cancelBubble=true};navigationButtonsDivInner=document.createElement("div");navigationButtonsDivInner.className="inappbrowser-app-bar-inner";navigationButtonsDivInner.onclick=function(i){i.cancelBubble=true};backButton=document.createElement("div");backButton.innerText="back";backButton.className="app-bar-action action-back";backButton.addEventListener("click",function(i){if(popup.canGoBack){popup.goBack()}});forwardButton=document.createElement("div");forwardButton.innerText="forward";forwardButton.className="app-bar-action action-forward";forwardButton.addEventListener("click",function(i){if(popup.canGoForward){popup.goForward()}});closeButton=document.createElement("div");closeButton.innerText="close";closeButton.className="app-bar-action action-close";closeButton.addEventListener("click",function(i){setTimeout(function(){IAB.close(navigationEventsCallback)},0)});if(!isWebViewAvailable){backButton.setAttribute("disabled","true");forwardButton.setAttribute("disabled","true")}navigationButtonsDivInner.appendChild(backButton);navigationButtonsDivInner.appendChild(forwardButton);navigationButtonsDivInner.appendChild(closeButton);navigationButtonsDiv.appendChild(navigationButtonsDivInner);browserWrap.appendChild(navigationButtonsDiv)}else{popup.style.height="100%"}attachNavigationEvents(popup,navigationEventsCallback);if(isWebViewAvailable){h=h.replace("ms-appx://","ms-appx-web://")}popup.src=h}}})},injectScriptCode:function(c,a,b){setImmediate(function(){var d=b[0],e=b[1];if(isWebViewAvailable&&browserWrap&&popup){var f=popup.invokeScriptAsync("eval",d);f.oncomplete=function(h){var g=(h&&h.target)?[h.target.result]:[null];e&&c(g)};f.onerror=function(){};f.start()}})},injectScriptFile:function(c,a,b){setImmediate(function(){var d=b[0],f=b[1];if(!!d){d=urlutil.makeAbsolute(d)}if(isWebViewAvailable&&browserWrap&&popup){var e=new Windows.Foundation.Uri(d);Windows.Storage.StorageFile.getFileFromApplicationUriAsync(e).done(function(g){Windows.Storage.FileIO.readTextAsync(g).done(function(h){var i=popup.invokeScriptAsync("eval",h);i.oncomplete=function(k){var j=[k.target.result];f&&c(j)};i.onerror=function(){};i.start()})})}})},injectStyleCode:function(c,a,b){setImmediate(function(){var d=b[0],e=b[1];if(isWebViewAvailable&&browserWrap&&popup){injectCSS(popup,d,e&&c)}})},injectStyleFile:function(c,a,b){setImmediate(function(){var d=b[0],f=b[1];d=d&&urlutil.makeAbsolute(d);if(isWebViewAvailable&&browserWrap&&popup){var e=new Windows.Foundation.Uri(d);Windows.Storage.StorageFile.getFileFromApplicationUriAsync(e).then(function(g){return Windows.Storage.FileIO.readTextAsync(g)}).done(function(g){injectCSS(popup,g,f&&c)},function(){})}})}};function injectCSS(d,a,f){var b=JSON.stringify(a);var c="(function(d){var c=d.createElement('style');c.innerHTML=%s;d.head.appendChild(c);})(document)".replace("%s",b);var e=d.invokeScriptAsync("eval",c);e.oncomplete=function(){f&&f([])};e.onerror=function(){};e.start()}module.exports=IAB;require("cordova/exec/proxy").add("InAppBrowser",module.exports);