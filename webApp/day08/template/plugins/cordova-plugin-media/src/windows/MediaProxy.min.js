var Media=require("cordova-plugin-media.Media");var MediaError=require("cordova-plugin-media.MediaError");var recordedFile;var tempFolderAppDataBasePath="ms-appdata:///temp/",localFolderAppDataBasePath="ms-appdata:///local/",tempFolderFullPath=Windows.Storage.ApplicationData.current.temporaryFolder.path,localFolderFullPath=Windows.Storage.ApplicationData.current.localFolder.path;var PARAMETER_IS_INCORRECT=-2147024809;var SUPPORTED_EXTENSIONS=[".mp3",".wma",".wav",".cda",".adx",".wm",".m3u",".wmx",".m4a"];var SUPPORTED_PREFIXES=["http","https","rstp"];module.exports={mediaCaptureMrg:null,create:function(e,d,f){var a=f[0];var g=processUri(f[1]);var h=!!f[2];var b=Media.get(a);Media.prototype.node=null;var c=f[1].split(":").shift();var i=g.extension;if(b.node===null){if(SUPPORTED_EXTENSIONS.indexOf(i)===-1&&SUPPORTED_PREFIXES.indexOf(c)===-1){d&&d({code:MediaError.MEDIA_ERR_ABORTED});return false}if(h===true){b.node=new Audio();b.node.msAudioCategory="BackgroundCapableMedia";b.node.src=g.absoluteCanonicalUri;b.node.onloadstart=function(){Media.onStatus(a,Media.MEDIA_STATE,Media.MEDIA_STARTING)};b.node.ontimeupdate=function(j){Media.onStatus(a,Media.MEDIA_POSITION,j.target.currentTime)};b.node.onplaying=function(){Media.onStatus(a,Media.MEDIA_STATE,Media.MEDIA_RUNNING)};b.node.ondurationchange=function(j){Media.onStatus(a,Media.MEDIA_DURATION,j.target.duration||-1)};b.node.onerror=function(k){var j=k.target.error.code===MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED?{code:MediaError.MEDIA_ERR_ABORTED}:k.target.error;Media.onStatus(a,Media.MEDIA_ERROR,j)};b.node.onended=function(){Media.onStatus(a,Media.MEDIA_STATE,Media.MEDIA_STOPPED)}}}return true},startPlayingAudio:function(d,e,a){var f=a[0];var c=Media.get(f);if(!c.node){a[2]=true;if(!module.exports.create(d,e,a)){return}}try{c.node.play()}catch(b){e&&e({code:MediaError.MEDIA_ERR_ABORTED})}},stopPlayingAudio:function(d,e,a){var f=a[0];try{var c=Media.get(f);c.node.pause();c.node.currentTime=0;Media.onStatus(f,Media.MEDIA_STATE,Media.MEDIA_STOPPED)}catch(b){e("Failed to stop: "+b)}},seekToAudio:function(e,f,b){var g=b[0];var a=b[1];var d=Media.get(g);try{d.node.currentTime=a/1000;e(d.node.currentTime)}catch(c){f("Failed to seek: "+c)}},pausePlayingAudio:function(d,e,a){var f=a[0];var c=Media.get(f);try{c.node.pause();Media.onStatus(f,Media.MEDIA_STATE,Media.MEDIA_PAUSED)}catch(b){e("Failed to pause: "+b)}},getCurrentPositionAudio:function(d,e,a){var f=a[0];try{var c=(Media.get(f)).node.currentTime;d(c)}catch(b){e(b)}},startRecordingAudio:function(e,d,f){var b=f[0];var h=processUri(f[1]);var j=parseUriToPathAndFilename(h);var i=j.fileName;var k=function(){Media.onStatus(b,Media.MEDIA_STATE,Media.MEDIA_RUNNING)};var g=function(l){Media.onStatus(b,Media.MEDIA_ERROR,l)};Media.prototype.mediaCaptureMgr=null;var c=(Media.get(b));var a=new Windows.Media.Capture.MediaCaptureInitializationSettings();a.streamingCaptureMode=Windows.Media.Capture.StreamingCaptureMode.audio;c.mediaCaptureMgr=new Windows.Media.Capture.MediaCapture();c.mediaCaptureMgr.addEventListener("failed",g);c.mediaCaptureMgr.initializeAsync(a).done(function(l){c.mediaCaptureMgr.addEventListener("recordlimitationexceeded",g);c.mediaCaptureMgr.addEventListener("failed",g);Windows.Storage.ApplicationData.current.temporaryFolder.createFileAsync(i,Windows.Storage.CreationCollisionOption.replaceExisting).done(function(m){recordedFile=m;var n=null;switch(m.fileType){case".m4a":n=Windows.Media.MediaProperties.MediaEncodingProfile.createM4a(Windows.Media.MediaProperties.AudioEncodingQuality.auto);break;case".mp3":n=Windows.Media.MediaProperties.MediaEncodingProfile.createMp3(Windows.Media.MediaProperties.AudioEncodingQuality.auto);break;case".wma":n=Windows.Media.MediaProperties.MediaEncodingProfile.createWma(Windows.Media.MediaProperties.AudioEncodingQuality.auto);break;default:g("Invalid file type for record");break}c.mediaCaptureMgr.startRecordToStorageFileAsync(n,m).done(k,g)},g)},g)},stopRecordingAudio:function(f,e,g){var a=g[0];var b=Media.get(a);var i=processUri(b.src);var k=parseUriToPathAndFilename(i);var d=k.path;var j=k.fileName;var c=k.fsType;var l=function(){Media.onStatus(a,Media.MEDIA_STATE,Media.MEDIA_STOPPED)};var h=function(m){Media.onStatus(a,Media.MEDIA_ERROR,m)};b.mediaCaptureMgr.stopRecordAsync().done(function(){if(c===fsTypes.TEMPORARY){if(!d){l()}else{Windows.Storage.ApplicationData.current.temporaryFolder.getFolderAsync(d).done(function(m){recordedFile.copyAsync(m,j,Windows.Storage.CreationCollisionOption.replaceExisting).done(l,h)},h)}}else{if(!d){recordedFile.copyAsync(Windows.Storage.ApplicationData.current.localFolder,j,Windows.Storage.CreationCollisionOption.replaceExisting).done(l,h)}else{Windows.Storage.ApplicationData.current.localFolder.getFolderAsync(d).done(function(m){recordedFile.copyAsync(m,j,Windows.Storage.CreationCollisionOption.replaceExisting).done(l,h)},h)}}},h)},release:function(d,e,a){var f=a[0];var c=Media.get(f);try{if(c.node){c.node.onloadedmetadata=null;c.node.onerror=null;c.node.src=null;delete c.node}}catch(b){e("Failed to release: "+b)}},setVolume:function(d,e,a){var f=a[0];var c=a[1];var b=Media.get(f);b.volume=c}};function setTemporaryFsByDefault(c){var a;try{a=new Windows.Foundation.Uri(c)}catch(b){if(b.number===PARAMETER_IS_INCORRECT){a=new Windows.Foundation.Uri(tempFolderAppDataBasePath,c)}else{throw b}}finally{return a}}function fullPathToAppData(a){if(a.schemeName==="file"){if(a.rawUri.indexOf(Windows.Storage.ApplicationData.current.localFolder.path)!==-1){a=new Windows.Foundation.Uri(localFolderAppDataBasePath,a.rawUri.replace(localFolderFullPath,"").replace(/^[\\\/]{1,2}/,""))}else{if(a.rawUri.indexOf(Windows.Storage.ApplicationData.current.temporaryFolder.path)!==-1){a=new Windows.Foundation.Uri(tempFolderAppDataBasePath,a.rawUri.replace(tempFolderFullPath,"").replace(/^[\\\/]{1,2}/,""))}else{throw new Error("Not supported file uri: "+a.rawUri)}}}return a}function cdvfileToAppData(b){var a;if(b.schemeName==="cdvfile"){a=b.path.split("/")[1];if(a==="temporary"){return new Windows.Foundation.Uri(tempFolderAppDataBasePath,b.path.split("/").slice(2).join("/"))}else{if(a==="persistent"){return new Windows.Foundation.Uri(localFolderAppDataBasePath,b.path.split("/").slice(2).join("/"))}else{throw new Error(a+" cdvfile root is not supported on Windows")}}}return b}function processUri(b){b=b.replace(/([^\/:])(\/\/)([^\/])/g,"$1/$3");b=b.replace(/^[\\\/]{1,2}/,"");var a=setTemporaryFsByDefault(b);a=fullPathToAppData(a);a=cdvfileToAppData(a);return a}var fsTypes={PERSISTENT:"PERSISTENT",TEMPORARY:"TEMPORARY"};function parseUriToPathAndFilename(b){var a=b.path.split("/").slice(2).join("\\");var c=a.substr(0,a.lastIndexOf("\\"));var e=a.replace(c+"\\","");var d;if(b.path.split("/")[1]==="local"){d=fsTypes.PERSISTENT}else{if(b.path.split("/")[1]==="temp"){d=fsTypes.TEMPORARY}}return{path:c,fileName:e,fsType:d}}require("cordova/exec/proxy").add("Media",module.exports);