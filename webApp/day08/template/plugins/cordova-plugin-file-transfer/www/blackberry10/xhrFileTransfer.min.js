var cordova=require("cordova"),resolve=cordova.require("cordova-plugin-file.resolveLocalFileSystemURIProxy"),requestAnimationFrame=cordova.require("cordova-plugin-file.bb10RequestAnimationFrame"),xhr={};function getParentPath(a){var b=a.lastIndexOf("/");return a.substring(0,b+1)}function getFileName(a){var b=a.lastIndexOf("/");return a.substring(b+1)}function checkURL(a){return a.indexOf(" ")===-1?true:false}module.exports={abort:function(c,a,b){var d=b[0];if(xhr[d]){xhr[d].abort();if(typeof(c)==="function"){c()}}else{if(typeof(a)==="function"){a()}}},upload:function(i,d,k){var f=k[0],e=k[1],l=k[2],h=k[3],b=k[4],g=k[5],m=k[7],c=k[8],j=function(n){if(typeof(i)==="function"){i(n)}},a=function(n){delete xhr[l];if(typeof(d)==="function"){d(n)}};if(!checkURL(e)){a(new FileTransferError(FileTransferError.INVALID_URL_ERR,e,f))}xhr[l]=new XMLHttpRequest();xhr[l].onabort=function(){a(new FileTransferError(FileTransferError.ABORT_ERR,e,f,this.status,xhr[l].response))};resolve(function(n){requestAnimationFrame(function(){n.nativeEntry.file(function(q){function r(u){var v=new FormData();v.append(l,u,h);for(var x in g){if(g.hasOwnProperty(x)){v.append(x,g[x])}}xhr[l].open("POST",e);xhr[l].onload=function(z){if(xhr[l].status===200){var y=new FileUploadResult();y.bytesSent=q.size;y.responseCode=xhr[l].status;y.response=xhr[l].response;delete xhr[l];j(y)}else{if(xhr[l].status===404){a(new FileTransferError(FileTransferError.INVALID_URL_ERR,e,f,xhr[l].status,xhr[l].response))}else{a(new FileTransferError(FileTransferError.CONNECTION_ERR,e,f,xhr[l].status,xhr[l].response))}}};xhr[l].ontimeout=function(y){a(new FileTransferError(FileTransferError.CONNECTION_ERR,e,f,xhr[l].status,xhr[l].response))};xhr[l].onerror=function(){a(new FileTransferError(FileTransferError.CONNECTION_ERR,e,f,this.status,xhr[l].response))};xhr[l].upload.onprogress=function(y){if(y.loaded>0){j(y)}};for(var w in c){if(c.hasOwnProperty(w)){xhr[l].setRequestHeader(w,c[w])}}requestAnimationFrame(function(){xhr[l].send(v)})}var s;if(m===true){s=1024*1024}else{s=q.size}var t=0;var o=s;while(t<q.size){var p=q.slice(t,o,b);r(p);t=o;o=t+s}},function(o){a(new FileTransferError(FileTransferError.FILE_NOT_FOUND_ERR,e,f))})})},function(n){a(new FileTransferError(FileTransferError.FILE_NOT_FOUND_ERR,e,f))},[f])},download:function(i,f,l){var a=l[0],j=l[1],c=l[3],e=l[4],d,k=function(m){if(typeof(i)==="function"){i(m)}},b=function(n){var m;delete xhr[c];if(typeof(f)==="function"){if(n&&n.body&&typeof(n.body)==="object"){m=new FileReader()._realReader;m.onloadend=function(){n.body=this.result;f(n)};m.onerror=function(){f(n)};m.readAsText(n.body)}else{f(n)}}};if(!checkURL(a)){b(new FileTransferError(FileTransferError.INVALID_URL_ERR,a,j))}xhr[c]=new XMLHttpRequest();function g(m){m.createWriter(function(n){d=n;d.onwriteend=function(o){if(!o.target.error){m.filesystemName=m.filesystem.name;delete xhr[c];k(m)}else{b(o.target.error)}};d.onerror=function(o){b(o.target.error)};d.write(new Blob([xhr[c].response]))},function(n){b(n)})}xhr[c].onerror=function(m){b(new FileTransferError(FileTransferError.CONNECTION_ERR,a,j,xhr[c].status,xhr[c].response))};xhr[c].onabort=function(m){b(new FileTransferError(FileTransferError.ABORT_ERR,a,j,xhr[c].status,xhr[c].response))};xhr[c].onload=function(){if(xhr[c].readyState===xhr[c].DONE){if(xhr[c].status===200&&xhr[c].response){resolveLocalFileSystemURI(getParentPath(j),function(m){m.getFile(getFileName(j),{create:true},g,function(n){b(new FileTransferError(FileTransferError.FILE_NOT_FOUND_ERR,a,j,xhr[c].status,xhr[c].response))})},function(m){b(new FileTransferError(FileTransferError.FILE_NOT_FOUND_ERR,a,j,xhr[c].status,xhr[c].response))})}else{if(xhr[c].status===404){b(new FileTransferError(FileTransferError.INVALID_URL_ERR,a,j,xhr[c].status,xhr[c].response))}else{b(new FileTransferError(FileTransferError.CONNECTION_ERR,a,j,xhr[c].status,xhr[c].response))}}}};xhr[c].onprogress=function(m){k(m)};xhr[c].open("GET",a,true);for(var h in e){if(e.hasOwnProperty(h)){xhr[c].setRequestHeader(h,e[h])}}xhr[c].responseType="blob";requestAnimationFrame(function(){if(xhr[c]){xhr[c].send()}})}};