var FileTransferError=require("./FileTransferError"),xhr={};function getParentPath(a){var b=a.lastIndexOf("/");return a.substring(0,b+1)}function getFileName(a){var b=a.lastIndexOf("/");return a.substring(b+1)}module.exports={abort:function(a,b,c){var d=c[0];if(xhr[d]){xhr[d].abort();if(typeof(a)==="function"){a()}}else{if(typeof(b)==="function"){b()}}},upload:function(c,i,k){var f=k[0],e=k[1],l=k[2],h=k[3],b=k[4],g=k[5],d=k[8];xhr[l]=new XMLHttpRequest({mozSystem:true});xhr[l].onabort=function(){a(new FileTransferError(FileTransferError.ABORT_ERR,e,f,this.status,xhr[l].response))};window.resolveLocalFileSystemURL(f,function(m){m.file(function(o){var n=new FileReader();n.onloadend=function(){var p=new Blob([this.result],{type:b});var q=new FormData();q.append(l,p,h);for(var s in g){if(g.hasOwnProperty(s)){q.append(s,g[s])}}xhr[l].open("POST",e);xhr[l].onload=function(u){if(xhr[l].status===200){var t=new FileUploadResult();t.bytesSent=p.size;t.responseCode=xhr[l].status;t.response=xhr[l].response;delete xhr[l];j(t)}else{if(xhr[l].status===404){a(new FileTransferError(FileTransferError.INVALID_URL_ERR,e,f,xhr[l].status,xhr[l].response))}else{a(new FileTransferError(FileTransferError.CONNECTION_ERR,e,f,xhr[l].status,xhr[l].response))}}};xhr[l].ontimeout=function(){a(new FileTransferError(FileTransferError.CONNECTION_ERR,e,f,xhr[l].status,xhr[l].response))};xhr[l].onerror=function(){a(new FileTransferError(FileTransferError.CONNECTION_ERR,e,f,this.status,xhr[l].response))};for(var r in d){if(d.hasOwnProperty(r)){xhr[l].setRequestHeader(r,d[r])}}xhr[l].send(q)};n.readAsArrayBuffer(o)},function(){a(new FileTransferError(FileTransferError.FILE_NOT_FOUND_ERR,e,f))})},function(){a(new FileTransferError(FileTransferError.FILE_NOT_FOUND_ERR,e,f))});function j(m){if(typeof(c)==="function"){c(m)}}function a(m){delete xhr[l];if(typeof(i)==="function"){i(m)}}},download:function(d,h,k){var a=k[0],i=k[1],c=k[3],e=k[4];xhr[c]=new XMLHttpRequest({mozSystem:true});xhr[c].onload=function(){if(xhr[c].readyState===xhr[c].DONE){if(xhr[c].status===200&&xhr[c].response){window.resolveLocalFileSystemURL(getParentPath(i),function(l){l.getFile(getFileName(i),{create:true},f,function(m){b(new FileTransferError(FileTransferError.FILE_NOT_FOUND_ERR,a,i,xhr[c].status,xhr[c].response))})},function(){b(new FileTransferError(FileTransferError.FILE_NOT_FOUND_ERR,a,i,xhr[c].status,xhr[c].response))})}else{if(xhr[c].status===404){b(new FileTransferError(FileTransferError.INVALID_URL_ERR,a,i,xhr[c].status,xhr[c].response))}else{b(new FileTransferError(FileTransferError.CONNECTION_ERR,a,i,xhr[c].status,xhr[c].response))}}}};function f(l){l.createWriter(function(m){m.onwriteend=function(n){if(!n.target.error){l.filesystemName=l.filesystem.name;delete xhr[c];j(l)}else{b(n.target.error)}};m.onerror=function(n){b(n.target.error)};m.write(new Blob([xhr[c].response]))},function(m){b(m)})}xhr[c].onerror=function(l){b(new FileTransferError(FileTransferError.CONNECTION_ERR,a,i,xhr[c].status,xhr[c].response))};xhr[c].onabort=function(l){b(new FileTransferError(FileTransferError.ABORT_ERR,a,i,xhr[c].status,xhr[c].response))};xhr[c].open("GET",a,true);for(var g in e){if(e.hasOwnProperty(g)){xhr[c].setRequestHeader(g,e[g])}}xhr[c].responseType="blob";setTimeout(function(){if(xhr[c]){xhr[c].send()}},0);function j(l){if(typeof(d)==="function"){d(l)}}function b(l){delete xhr[c];if(typeof(h)==="function"){h(l)}}}};require("cordova/exec/proxy").add("FileTransfer",module.exports);