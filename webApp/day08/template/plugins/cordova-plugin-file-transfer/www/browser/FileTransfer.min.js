var argscheck=require("cordova/argscheck"),FileTransferError=require("./FileTransferError");function getParentPath(a){var b=a.lastIndexOf("/");return a.substring(0,b+1)}function getFileName(a){var b=a.lastIndexOf("/");return a.substring(b+1)}function getUrlCredentials(c){var b=/^https?\:\/\/(?:(?:(([^:@\/]*)(?::([^@\/]*))?)?@)?([^:\/?#]*)(?::(\d*))?).*$/,a=b.exec(c);return a&&a[1]}function getBasicAuthHeader(d){var e=null;if(window.btoa){var c=getUrlCredentials(d);if(c){var b="Authorization";var a="Basic "+window.btoa(c);e={name:b,value:a}}}return e}function checkURL(a){return a.indexOf(" ")===-1?true:false}var idCounter=0;var transfers={};var FileTransfer=function(){this._id=++idCounter;this.onprogress=null};FileTransfer.prototype.upload=function(g,f,c,l,p){argscheck.checkArgs("ssFFO*","FileTransfer.upload",arguments);if(!checkURL(f)){if(l){l(new FileTransferError(FileTransferError.INVALID_URL_ERR,g,f))}return}p=p||{};var n=p.fileKey||"file";var j=p.fileName||"image.jpg";var b=p.mimeType||"image/jpeg";var i=p.params||{};var h=p.withCredentials||false;var d=p.headers||{};var a=p.httpMethod&&p.httpMethod.toUpperCase()==="PUT"?"PUT":"POST";var k=getBasicAuthHeader(f);if(k){f=f.replace(getUrlCredentials(f)+"@","");d[k.name]=k.value}var m=this;var o=transfers[this._id]=new XMLHttpRequest();o.withCredentials=h;var e=l&&function(t,q,r){if(transfers[this._id]){delete transfers[this._id]}var s=new FileTransferError(t,g,f,q,r);if(l){l(s)}};window.resolveLocalFileSystemURL(g,function(q){q.file(function(s){var r=new FileReader();r.onloadend=function(){var t=new Blob([this.result],{type:b});var u=new FormData();u.append(n,t,j);for(var w in i){if(i.hasOwnProperty(w)){u.append(w,i[w])}}o.open(a,f);for(var v in d){if(d.hasOwnProperty(v)){o.setRequestHeader(v,d[v])}}o.onload=function(){if(this.status===200){var x=new FileUploadResult();x.bytesSent=t.size;x.responseCode=this.status;x.response=this.response;delete transfers[m._id];c(x)}else{if(this.status===404){e(FileTransferError.INVALID_URL_ERR,this.status,this.response)}else{e(FileTransferError.CONNECTION_ERR,this.status,this.response)}}};o.ontimeout=function(){e(FileTransferError.CONNECTION_ERR,this.status,this.response)};o.onerror=function(){e(FileTransferError.CONNECTION_ERR,this.status,this.response)};o.onabort=function(){e(FileTransferError.ABORT_ERR,this.status,this.response)};o.upload.onprogress=function(x){if(m.onprogress){m.onprogress(x)}};o.send(u);if(!transfers[m._id]){o.abort()}};r.readAsArrayBuffer(s)},function(){e(FileTransferError.FILE_NOT_FOUND_ERR)})},function(){e(FileTransferError.FILE_NOT_FOUND_ERR)})};FileTransfer.prototype.download=function(a,k,b,i,h,m){argscheck.checkArgs("ssFF*","FileTransfer.download",arguments);if(!checkURL(a)){if(i){i(new FileTransferError(FileTransferError.INVALID_URL_ERR,a,k))}return}m=m||{};var c=m.headers||{};var e=m.withCredentials||false;var f=getBasicAuthHeader(a);if(f){a=a.replace(getUrlCredentials(a)+"@","");c[f.name]=f.value}var j=this;var l=transfers[this._id]=new XMLHttpRequest();l.withCredentials=e;var d=i&&function(r,o,p){if(transfers[j._id]){delete transfers[j._id]}if(p instanceof Blob){var n=new FileReader();n.readAsText(p);n.onloadend=function(t){var s=new FileTransferError(r,a,k,o,t.target.result);i(s)}}else{var q=new FileTransferError(r,a,k,o,p);i(q)}};l.onload=function(p){var n=function(){d(FileTransferError.FILE_NOT_FOUND_ERR)};var o=p.target;if((o.status===200||o.status===0)&&o.response){window.resolveLocalFileSystemURL(getParentPath(k),function(q){q.getFile(getFileName(k),{create:true},function r(s){s.createWriter(function(t){t.onwriteend=function(u){if(!u.target.error){s.filesystemName=s.filesystem.name;delete transfers[j._id];if(b){b(s)}}else{d(FileTransferError.FILE_NOT_FOUND_ERR)}};t.onerror=function(){d(FileTransferError.FILE_NOT_FOUND_ERR)};t.write(o.response)},n)},n)},n)}else{if(o.status===404){d(FileTransferError.INVALID_URL_ERR,o.status,o.response)}else{d(FileTransferError.CONNECTION_ERR,o.status,o.response)}}};l.onprogress=function(n){if(j.onprogress){j.onprogress(n)}};l.onerror=function(){d(FileTransferError.CONNECTION_ERR,this.status,this.response)};l.onabort=function(){d(FileTransferError.ABORT_ERR,this.status,this.response)};l.open("GET",a,true);for(var g in c){if(c.hasOwnProperty(g)){l.setRequestHeader(g,c[g])}}l.responseType="blob";l.send()};FileTransfer.prototype.abort=function(){if(this instanceof FileTransfer){if(transfers[this._id]){transfers[this._id].abort();delete transfers[this._id]}}};module.exports=FileTransfer;