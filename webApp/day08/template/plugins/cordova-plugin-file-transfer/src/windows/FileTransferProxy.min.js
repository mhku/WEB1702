var FTErr=require("./FileTransferError"),ProgressEvent=require("cordova-plugin-file.ProgressEvent"),FileUploadResult=require("cordova-plugin-file.FileUploadResult"),FileProxy=require("cordova-plugin-file.FileProxy");var appData=Windows.Storage.ApplicationData.current;var LINE_START="--";var LINE_END="\r\n";var BOUNDARY="+++++";var fileTransferOps=[];function cordovaPathToNative(a){var b=String(a);b=b.replace(/\//g,"\\");b=b.replace(/\\\\/g,"\\");b=b.replace(/\\+$/g,"");return b}function nativePathToCordova(a){return String(a).replace(/\\/g,"/")}function alreadyCancelled(a){var b=fileTransferOps[a];return b&&b.state===FileTransferOperation.CANCELLED}function doUpload(c,g,d,f,a,b){if(alreadyCancelled(g)){b(new FTErr(FTErr.ABORT_ERR,nativePathToCordova(d),f));return}var e=c.startAsync();fileTransferOps[g].promise=e;e.then(function(i){var l=fileTransferOps[g];if(l){l.state=FileTransferOperation.DONE;l.promise=null}var k=i.getResponseInformation();var j=new FileUploadResult(i.progress.bytesSent,k.statusCode,"");if(i.progress.bytesReceived===0){a(j);return}var h=new Windows.Storage.Streams.DataReader(i.getResultStreamAt(0));h.loadAsync(i.progress.bytesReceived).then(function(m){j.response=h.readString(m);a(j);h.close()})},function(h){var j=nativePathToCordova(d);var k=new WinJS.Promise(function(n){if(h.message==="Canceled"){n(new FTErr(FTErr.ABORT_ERR,j,f,null,null,h))}else{var m=c.getResponseInformation();if(!m){n(new FTErr(FTErr.CONNECTION_ERR,j,f))}else{var l=new Windows.Storage.Streams.DataReader(c.getResultStreamAt(0));l.loadAsync(c.progress.bytesReceived).then(function(o){var p=l.readString(o);n(new FTErr(FTErr.FILE_NOT_FOUND_ERR,j,f,m.statusCode,p,h));l.close()})}}});var i=fileTransferOps[g];if(i){i.state=FileTransferOperation.CANCELLED;i.promise=null}k.then(function(l){b(l)})},function(h){var i=new ProgressEvent("progress",{loaded:h.progress.bytesSent,total:h.progress.totalBytesToSend,target:h.resultFile});i.lengthComputable=true;a(i,{keepCallback:true})})}function FileTransferOperation(a,b){this.state=a;this.promise=b}FileTransferOperation.PENDING=0;FileTransferOperation.DONE=1;FileTransferOperation.CANCELLED=2;var HTTP_E_STATUS_NOT_MODIFIED=-2145844944;module.exports={upload:function(d,j,e){var o=e[0];var r=e[1];var h=e[2]||"source";var v=e[3];var i=e[4];var u=e[5];var c=e[8]||{};var l=e[9];var p=e[10];var w=typeof c["Content-Type"]==="undefined";function n(B){var z=atob(B);var A=new Array(z.length);for(var y=0;y<z.length;y++){A[y]=z.charCodeAt(y)}return new Uint8Array(A)}if(!o||(typeof o!=="string")){j(new FTErr(FTErr.FILE_NOT_FOUND_ERR,null,r));return}if(o.indexOf("data:")===0&&o.indexOf("base64")!==-1){var s=Windows.Storage.Streams.DataWriter(new Windows.Storage.Streams.InMemoryRandomAccessStream());s.unicodeEncoding=Windows.Storage.Streams.UnicodeEncoding.utf8;s.byteOrder=Windows.Storage.Streams.ByteOrder.littleEndian;var f=o.indexOf(",");if(f===-1){j(new FTErr(FTErr.INVALID_URL_ERR,v,r,null,null,"No comma in data: URI"));return}fileTransferOps[l]=new FileTransferOperation(FileTransferOperation.PENDING,null);var k=o.substr(f+1);var q=new Windows.Networking.BackgroundTransfer.BackgroundUploader();q.method=p;for(var t in c){if(c.hasOwnProperty(t)){q.setRequestHeader(t,c[t])}}if(w){var b="";for(var x in u){if(u.hasOwnProperty(x)){b+=LINE_START+BOUNDARY+LINE_END;b+='Content-Disposition: form-data; name="'+x+'"';b+=LINE_END+LINE_END;b+=u[x];b+=LINE_END}}var m=LINE_START+BOUNDARY+LINE_END;m+='Content-Disposition: form-data; name="file";';m+=' filename="'+v+'"'+LINE_END;m+="Content-Type: "+i+LINE_END+LINE_END;var a=LINE_END+LINE_START+BOUNDARY+LINE_START+LINE_END;q.setRequestHeader("Content-Type","multipart/form-data; boundary="+BOUNDARY);s.writeString(b);s.writeString(m);s.writeBytes(n(k));s.writeString(a)}else{s.writeBytes(n(k))}var g;s.storeAsync().then(function(){return s.flushAsync()}).then(function(){g=s.detachStream();g.seek(0);s.close();if(alreadyCancelled(l)){j(new FTErr(FTErr.ABORT_ERR,nativePathToCordova(o),r));return}var y=new Windows.Foundation.Uri(r);var A;try{A=q.createUploadFromStreamAsync(y,g)}catch(z){j(new FTErr(FTErr.INVALID_URL_ERR));return}A.then(function(B){doUpload(B,l,o,r,d,j)},function(C){var B=new FTErr(FTErr.INVALID_URL_ERR);B.exception=C;j(B)})});return}if(o.substr(0,8)==="file:///"){o=appData.localFolder.path+o.substr(8).split("/").join("\\")}else{if(o.indexOf("ms-appdata:///")===0){o=o.replace("ms-appdata:///local",appData.localFolder.path).replace("ms-appdata:///temp",appData.temporaryFolder.path)}else{if(o.indexOf("cdvfile://")===0){o=o.replace("cdvfile://localhost/persistent",appData.localFolder.path).replace("cdvfile://localhost/temporary",appData.temporaryFolder.path)}}}o=cordovaPathToNative(o);fileTransferOps[l]=new FileTransferOperation(FileTransferOperation.PENDING,null);Windows.Storage.StorageFile.getFileFromPathAsync(o).then(function(y){if(!v){v=y.name}if(!i){i=y.contentType}if(alreadyCancelled(l)){j(new FTErr(FTErr.ABORT_ERR,nativePathToCordova(o),r));return}var D=new Windows.Networking.BackgroundTransfer.BackgroundUploader();D.method=p;for(var C in c){if(c.hasOwnProperty(C)){D.setRequestHeader(C,c[C])}}var A=new Windows.Foundation.Uri(r);var H;try{if(w){var E=[];for(var G in u){if(u.hasOwnProperty(G)&&u[G]!==null&&u[G]!==undefined&&u[G].toString()!==""){var B=new Windows.Networking.BackgroundTransfer.BackgroundTransferContentPart();B.setHeader("Content-Disposition",'form-data; name="'+G+'"');B.setText(u[G]);E.push(B)}}var z=new Windows.Networking.BackgroundTransfer.BackgroundTransferContentPart(h,v);z.setFile(y);E.push(z);H=D.createUploadAsync(A,E)}else{H=WinJS.Promise.wrap(D.createUpload(A,y))}}catch(F){j(new FTErr(FTErr.INVALID_URL_ERR));return}H.then(function(I){doUpload(I,l,o,r,d,j)},function(J){var I=new FTErr(FTErr.INVALID_URL_ERR);I.exception=J;j(I)})},function(y){j(new FTErr(FTErr.FILE_NOT_FOUND_ERR,v,r,null,null,y))})},download:function(c,h,m){var b=m[0];var k=m[1];var g=m[3];var d=m[4]||{};if(!k){h(new FTErr(FTErr.FILE_NOT_FOUND_ERR));return}if(k.substr(0,8)==="file:///"){k=appData.localFolder.path+k.substr(8).split("/").join("\\")}else{if(k.indexOf("ms-appdata:///")===0){k=k.replace("ms-appdata:///local",appData.localFolder.path).replace("ms-appdata:///temp",appData.temporaryFolder.path)}else{if(k.indexOf("cdvfile://")===0){k=k.replace("cdvfile://localhost/persistent",appData.localFolder.path).replace("cdvfile://localhost/temporary",appData.temporaryFolder.path)}}}k=cordovaPathToNative(k);var l=k.substr(0,k.lastIndexOf("\\"));var f=k.substr(k.lastIndexOf("\\")+1);if(l===null||f===null){h(new FTErr(FTErr.FILE_NOT_FOUND_ERR));return}var j="~"+f;var a=null;fileTransferOps[g]=new FileTransferOperation(FileTransferOperation.PENDING,null);var e=function(n){n.createFileAsync(j,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(p){if(alreadyCancelled(g)){h(new FTErr(FTErr.ABORT_ERR,b,k));return}var r=new Windows.Networking.BackgroundTransfer.BackgroundDownloader();for(var t in d){if(d.hasOwnProperty(t)){r.setRequestHeader(t,d[t])}}try{var q=Windows.Foundation.Uri(b);a=r.createDownload(q,p)}catch(s){h(new FTErr(FTErr.INVALID_URL_ERR));return}var o=a.startAsync();fileTransferOps[g].promise=o;o.then(function(){var u=fileTransferOps[g];if(u){u.state=FileTransferOperation.DONE;u.promise=null}p.renameAsync(f,Windows.Storage.CreationCollisionOption.replaceExisting).done(function(){var v=p.path.replace(appData.localFolder.path,"ms-appdata:///local").replace(appData.temporaryFolder.path,"ms-appdata:///temp").replace(/\\/g,"/");FileProxy.resolveLocalFileSystemURI(c,null,[v])},function(v){h(new FTErr(FTErr.FILE_NOT_FOUND_ERR,b,k,null,null,v))})},function(u){var v=new WinJS.Promise(function(y){if(u.message==="Canceled"){y(new FTErr(FTErr.ABORT_ERR,b,k,null,null,u))}else{if(u&&u.number===HTTP_E_STATUS_NOT_MODIFIED){y(new FTErr(FTErr.NOT_MODIFIED_ERR,b,k,304,null,u))}else{var x=a.getResponseInformation();if(!x){y(new FTErr(FTErr.CONNECTION_ERR,b,k))}else{var w=new Windows.Storage.Streams.DataReader(a.getResultStreamAt(0));w.loadAsync(a.progress.bytesReceived).then(function(z){var A=w.readString(z);y(new FTErr(FTErr.FILE_NOT_FOUND_ERR,b,k,x.statusCode,A,u))})}}}});v.then(function(x){var w=fileTransferOps[g];if(w){w.state=FileTransferOperation.CANCELLED;w.promise=null}p.deleteAsync().then(function(){h(x)})})},function(u){var v=new ProgressEvent("progress",{loaded:u.progress.bytesReceived,total:u.progress.totalBytesToReceive,target:u.resultFile});v.lengthComputable=(u.progress.bytesReceived>0)&&(u.progress.totalBytesToReceive>0);c(v,{keepCallback:true})})},function(o){h(new FTErr(FTErr.FILE_NOT_FOUND_ERR,b,k,null,null,o))})};var i=function(n){h(new FTErr(FTErr.FILE_NOT_FOUND_ERR,b,k,null,null,n))};Windows.Storage.StorageFolder.getFolderFromPathAsync(l).then(e,function(n){if(n.number===-2147024894){var o=l.substr(0,l.lastIndexOf("\\")),p=l.substr(l.lastIndexOf("\\")+1);Windows.Storage.StorageFolder.getFolderFromPathAsync(o).then(function(q){q.createFolderAsync(p).then(e,i)},i)}else{i()}})},abort:function(b,d,c){var e=c[0];var a=fileTransferOps[e];if(a){a.state=FileTransferOperation.CANCELLED;a.promise&&a.promise.cancel()}else{if(typeof e!=="undefined"){fileTransferOps[e]=new FileTransferOperation(FileTransferOperation.CANCELLED,null)}}}};require("cordova/exec/proxy").add("FileTransfer",module.exports);