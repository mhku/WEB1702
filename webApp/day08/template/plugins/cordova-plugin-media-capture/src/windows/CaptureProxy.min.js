var MediaFile=require("cordova-plugin-media-capture.MediaFile");var CaptureError=require("cordova-plugin-media-capture.CaptureError");var CaptureAudioOptions=require("cordova-plugin-media-capture.CaptureAudioOptions");var CaptureImageOptions=require("cordova-plugin-media-capture.CaptureImageOptions");var CaptureVideoOptions=require("cordova-plugin-media-capture.CaptureVideoOptions");var MediaFileData=require("cordova-plugin-media-capture.MediaFileData");function MediaCaptureProxy(){var d,k=null,j=null,f=null,g=false,i,b,l=null;var e=Windows.Media.Capture;function m(){var n=Array.prototype.slice.call(arguments);n.forEach(function(p){var o=document.getElementById(p);if(o){var q=o.style.display;o.style.display=q==="none"?"block":"none"}})}function a(){var n="margin: 7px; border: 2.5px solid white; width: 45%; height: 35px; color: white; background-color: black;";d=document.createElement("div");d.style.cssText="background-position: 50% 50%; background-repeat: no-repeat; background-size: contain; background-color: black; left: 0px; top: 0px; width: 100%; height: 100%; position: fixed; z-index: 9999";d.innerHTML='<video id="capturePreview" style="width: 100%; height: 100%"></video><div id="previewButtons" style="width: 100%; bottom: 0px; display: flex; position: absolute; justify-content: space-around; background-color: black;"><button id="takePicture" style="'+n+'">Capture</button><button id="cancelCapture" style="'+n+'">Cancel</button><button id="selectPicture" style="display: none; '+n+'">Accept</button><button id="retakePicture" style="display: none; '+n+'">Retake</button></div>';document.body.appendChild(d);k=document.getElementById("capturePreview");j=document.getElementById("cancelCapture");l=new e.MediaCapture();f=new e.MediaCaptureInitializationSettings();f.streamingCaptureMode=e.StreamingCaptureMode.audioAndVideo}function h(q,o,n,p){var r=Windows.Devices.Enumeration.Panel.back;Windows.Devices.Enumeration.DeviceInformation.findAllAsync(Windows.Devices.Enumeration.DeviceClass.videoCapture).done(function(s){if(s.length>0){s.forEach(function(t){if(t.enclosureLocation&&t.enclosureLocation.panel&&t.enclosureLocation.panel==r){f.videoDeviceId=t.id}});l.initializeAsync(f).done(function(){l.setPreviewRotation(Windows.Media.Capture.VideoRotation.clockwise90Degrees);k.msZoom=true;k.src=URL.createObjectURL(l);k.play();d.style.display="block";k.onclick=q;document.getElementById("takePicture").onclick=q;document.getElementById("cancelCapture").onclick=function(){o(CaptureError.CAPTURE_NO_MEDIA_FILES)};document.getElementById("selectPicture").onclick=n;document.getElementById("retakePicture").onclick=p},function(t){c();o(CaptureError.CAPTURE_INTERNAL_ERR,t)})}else{c();o(CaptureError.CAPTURE_INTERNAL_ERR)}})}function c(){k.pause();k.src=null;d&&document.body.removeChild(d);if(l){l.stopRecordAsync();l=null}}return{captureVideo:function(n,o){try{a();h(function(){if(!g){m("cancelCapture");document.getElementById("takePicture").text="Stop";var q=Windows.Media.MediaProperties.MediaEncodingProfile.createMp4(Windows.Media.MediaProperties.VideoEncodingQuality.auto),s=Windows.Storage.CreationCollisionOption.generateUniqueName,r=Windows.Storage.ApplicationData.current.localFolder;r.createFileAsync("cameraCaptureVideo.mp4",s).done(function(t){l.startRecordToStorageFileAsync(q,t).done(function(){b=t;g=true},function(u){c();o(CaptureError.CAPTURE_INTERNAL_ERR,u)})},function(t){c();o(CaptureError.CAPTURE_INTERNAL_ERR,t)})}else{l.stopRecordAsync().done(function(){c();n(b)})}},o)}catch(p){c();o(CaptureError.CAPTURE_INTERNAL_ERR,p)}},capturePhoto:function(n,o){try{a();h(function(){var q=Windows.Media.MediaProperties.ImageEncodingProperties.createJpeg(),r=Windows.Storage.CreationCollisionOption.replaceExisting,s=Windows.Storage.ApplicationData.current.temporaryFolder;s.createFileAsync("cameraCaptureImage.jpg",r).done(function(t){l.capturePhotoToStorageFileAsync(q,t).done(function(){i=t;d.style.backgroundImage='url("ms-appdata:///temp/'+t.name+'")';m("capturePreview","takePicture","cancelCapture","selectPicture","retakePicture")},function(u){c();o(CaptureError.CAPTURE_INTERNAL_ERR,u)})},function(t){c();o(CaptureError.CAPTURE_INTERNAL_ERR,t)})},function(q){c();o(q)},function(){var r=Windows.Storage.CreationCollisionOption.generateUniqueName,q=Windows.Storage.ApplicationData.current.localFolder;i.copyAsync(q,i.name,r).done(function(s){c();n(s)},function(s){c();o(s)})},function(){m("capturePreview","takePicture","cancelCapture","selectPicture","retakePicture")})}catch(p){c();o(CaptureError.CAPTURE_INTERNAL_ERR,p)}}}}module.exports={captureAudio:function(a,h,k){var p=k[0];var f=new CaptureAudioOptions();if(typeof(p.duration)=="undefined"){f.duration=3600}else{if(p.duration>0){f.duration=p.duration}else{h(new CaptureError(CaptureError.CAPTURE_INVALID_ARGUMENT));return}}var d=Windows.Media.Capture,i=Windows.Media.MediaProperties,e=Windows.Storage.ApplicationData.current.localFolder,n=Windows.Storage.NameCollisionOption.generateUniqueName;var m=new d.MediaCapture(),g=new d.MediaCaptureInitializationSettings(),j=new i.MediaEncodingProfile.createMp3(i.AudioEncodingQuality.auto),l=new i.MediaEncodingProfile.createM4a(i.AudioEncodingQuality.auto);g.streamingCaptureMode=d.StreamingCaptureMode.audio;var b,c;var o=function(){m.stopRecordAsync().then(function(){b.getBasicPropertiesAsync().then(function(r){var q=new MediaFile(b.name,"ms-appdata:///local/"+b.name,b.contentType,r.dateModified,r.size);q.fullPath=b.path;a([q])},function(){h(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})},function(){h(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})};m.initializeAsync(g).done(function(){e.createFileAsync("captureAudio.mp3",n).then(function(q){b=q;m.startRecordToStorageFileAsync(j,b).then(function(){c=setTimeout(o,f.duration*1000)},function(r){if(r.number===-1072868846){clearTimeout(c);e.createFileAsync("captureAudio.m4a",n).then(function(s){b=s;m.startRecordToStorageFileAsync(l,b).then(function(){c=setTimeout(o,f.duration*1000)},function(){h(new CaptureError(CaptureError.CAPTURE_INTERNAL_ERR));return})})}else{h(new CaptureError(CaptureError.CAPTURE_INTERNAL_ERR));return}})},function(){h(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})})},captureImage:function(b,f,h){var i=h[0];var e=Windows.Media.Capture;if(!e.CameraCaptureUI){function d(k,l){var j=new CaptureError(k);j.message=l;f(j)}var g=new MediaCaptureProxy();g.capturePhoto(function(j){j.getBasicPropertiesAsync().done(function(l){var k=new MediaFile(j.name,"ms-appdata:///local/"+j.name,j.contentType,l.dateModified,l.size);k.fullPath=j.path;b([k])},function(k){d(CaptureError.CAPTURE_INTERNAL_ERR,k)})},function(j){d(j)})}else{var c=new CaptureImageOptions();var a=new Windows.Media.Capture.CameraCaptureUI();a.photoSettings.allowCropping=true;a.photoSettings.maxResolution=Windows.Media.Capture.CameraCaptureUIMaxPhotoResolution.highestAvailable;a.photoSettings.format=Windows.Media.Capture.CameraCaptureUIPhotoFormat.jpeg;a.captureFileAsync(Windows.Media.Capture.CameraCaptureUIMode.photo).done(function(j){j.moveAsync(Windows.Storage.ApplicationData.current.localFolder,"cameraCaptureImage.jpg",Windows.Storage.NameCollisionOption.generateUniqueName).then(function(){j.getBasicPropertiesAsync().then(function(l){var k=new MediaFile(j.name,"ms-appdata:///local/"+j.name,j.contentType,l.dateModified,l.size);k.fullPath=j.path;b([k])},function(){f(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})},function(){f(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})},function(){f(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})}},captureVideo:function(b,f,h){var i=h[0];var d=Windows.Media.Capture;if(!d.CameraCaptureUI){function c(k,l){var j=new CaptureError(k);j.message=l;f(j)}var g=new MediaCaptureProxy();g.captureVideo(function(j){j.getBasicPropertiesAsync().done(function(l){var k=new MediaFile(j.name,"ms-appdata:///local/"+j.name,j.contentType,l.dateModified,l.size);k.fullPath=j.path;b([k])},function(k){c(CaptureError.CAPTURE_INTERNAL_ERR,k)})},c)}else{var e=new CaptureVideoOptions();if(i.duration&&i.duration>0){e.duration=i.duration}if(i.limit>1){e.limit=i.limit}var a=new Windows.Media.Capture.CameraCaptureUI();a.videoSettings.allowTrimming=true;a.videoSettings.format=Windows.Media.Capture.CameraCaptureUIVideoFormat.mp4;a.videoSettings.maxDurationInSeconds=e.duration;a.captureFileAsync(Windows.Media.Capture.CameraCaptureUIMode.video).then(function(j){j.moveAsync(Windows.Storage.ApplicationData.current.localFolder,"cameraCaptureVideo.mp4",Windows.Storage.NameCollisionOption.generateUniqueName).then(function(){j.getBasicPropertiesAsync().then(function(l){var k=new MediaFile(j.name,"ms-appdata:///local/"+j.name,j.contentType,l.dateModified,l.size);k.fullPath=j.path;b([k])},function(){f(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})},function(){f(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})},function(){f(new CaptureError(CaptureError.CAPTURE_NO_MEDIA_FILES))})}},getFormatData:function(a,b,c){Windows.Storage.StorageFile.getFileFromPathAsync(c[0]).then(function(d){var e=String(d.contentType).split("/")[0].toLowerCase();if(e==="audio"){d.properties.getMusicPropertiesAsync().then(function(f){a(new MediaFileData(null,f.bitrate,0,0,f.duration/1000))},function(){b(new CaptureError(CaptureError.CAPTURE_INVALID_ARGUMENT))})}else{if(e==="video"){d.properties.getVideoPropertiesAsync().then(function(f){a(new MediaFileData(null,f.bitrate,f.height,f.width,f.duration/1000))},function(){b(new CaptureError(CaptureError.CAPTURE_INVALID_ARGUMENT))})}else{if(e==="image"){d.properties.getImagePropertiesAsync().then(function(f){a(new MediaFileData(null,0,f.height,f.width,0))},function(){b(new CaptureError(CaptureError.CAPTURE_INVALID_ARGUMENT))})}else{b(new CaptureError(CaptureError.CAPTURE_INVALID_ARGUMENT))}}}},function(){b(new CaptureError(CaptureError.CAPTURE_INVALID_ARGUMENT))})}};require("cordova/exec/proxy").add("Capture",module.exports);