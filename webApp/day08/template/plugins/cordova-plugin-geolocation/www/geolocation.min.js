var argscheck=require("cordova/argscheck"),utils=require("cordova/utils"),exec=require("cordova/exec"),PositionError=require("./PositionError"),Position=require("./Position");var timers={};function parseParameters(a){var b={maximumAge:0,enableHighAccuracy:false,timeout:Infinity};if(a){if(a.maximumAge!==undefined&&!isNaN(a.maximumAge)&&a.maximumAge>0){b.maximumAge=a.maximumAge}if(a.enableHighAccuracy!==undefined){b.enableHighAccuracy=a.enableHighAccuracy}if(a.timeout!==undefined&&!isNaN(a.timeout)){if(a.timeout<0){b.timeout=0}else{b.timeout=a.timeout}}}return b}function createTimeout(a,c){var b=setTimeout(function(){clearTimeout(b);b=null;a({code:PositionError.TIMEOUT,message:"Position retrieval timed out."})},c);return b}var geolocation={lastPosition:null,getCurrentPosition:function(a,c,d){argscheck.checkArgs("fFO","geolocation.getCurrentPosition",arguments);d=parseParameters(d);var e={timer:null};var f=function(g){clearTimeout(e.timer);if(!(e.timer)){return}var h=new Position({latitude:g.latitude,longitude:g.longitude,altitude:g.altitude,accuracy:g.accuracy,heading:g.heading,velocity:g.velocity,altitudeAccuracy:g.altitudeAccuracy},g.timestamp);geolocation.lastPosition=h;a(h)};var b=function(h){clearTimeout(e.timer);e.timer=null;var g=new PositionError(h.code,h.message);if(c){c(g)}};if(geolocation.lastPosition&&d.maximumAge&&(((new Date()).getTime()-geolocation.lastPosition.timestamp)<=d.maximumAge)){a(geolocation.lastPosition)}else{if(d.timeout===0){b({code:PositionError.TIMEOUT,message:"timeout value in PositionOptions set to 0 and no cached Position object available, or cached Position object's age exceeds provided PositionOptions' maximumAge parameter."})}else{if(d.timeout!==Infinity){e.timer=createTimeout(b,d.timeout)}else{e.timer=true}exec(f,b,"Geolocation","getLocation",[d.enableHighAccuracy,d.maximumAge])}}return e},watchPosition:function(a,c,d){argscheck.checkArgs("fFO","geolocation.getCurrentPosition",arguments);d=parseParameters(d);var f=utils.createUUID();timers[f]=geolocation.getCurrentPosition(a,c,d);var b=function(h){clearTimeout(timers[f].timer);var g=new PositionError(h.code,h.message);if(c){c(g)}};var e=function(g){clearTimeout(timers[f].timer);if(d.timeout!==Infinity){timers[f].timer=createTimeout(b,d.timeout)}var h=new Position({latitude:g.latitude,longitude:g.longitude,altitude:g.altitude,accuracy:g.accuracy,heading:g.heading,velocity:g.velocity,altitudeAccuracy:g.altitudeAccuracy},g.timestamp);geolocation.lastPosition=h;a(h)};exec(e,b,"Geolocation","addWatch",[f,d.enableHighAccuracy]);return f},clearWatch:function(a){if(a&&timers[a]!==undefined){clearTimeout(timers[a].timer);timers[a].timer=false;exec(null,null,"Geolocation","clearWatch",[a])}}};module.exports=geolocation;