var pimContacts,contactUtils=require("./contactUtils"),contactConsts=require("./contactConsts"),ContactError=require("./ContactError"),ContactName=require("./ContactName"),ContactFindOptions=require("./ContactFindOptions"),noop=function(){};function getAccountFilters(a){if(a.includeAccounts){a.includeAccounts=a.includeAccounts.map(function(b){return b.id.toString()})}if(a.excludeAccounts){a.excludeAccounts=a.excludeAccounts.map(function(b){return b.id.toString()})}}function populateSearchFields(a){var e,b,d,c={},f=[];for(e=0,b=a.length;e<b;e++){if(a[e]==="*"){c[ContactFindOptions.SEARCH_FIELD_GIVEN_NAME]=true;c[ContactFindOptions.SEARCH_FIELD_FAMILY_NAME]=true;c[ContactFindOptions.SEARCH_FIELD_PHONE]=true;c[ContactFindOptions.SEARCH_FIELD_EMAIL]=true;c[ContactFindOptions.SEARCH_FIELD_ORGANIZATION_NAME]=true}else{if(a[e]==="displayName"||a[e]==="name"){c[ContactFindOptions.SEARCH_FIELD_GIVEN_NAME]=true;c[ContactFindOptions.SEARCH_FIELD_FAMILY_NAME]=true}else{if(a[e]==="nickname"){}else{if(a[e]==="phoneNumbers"){c[ContactFindOptions.SEARCH_FIELD_PHONE]=true}else{if(a[e]==="emails"){c[ContactFindOptions.SEARCH_FIELD_EMAIL]=true}else{if(field==="addresses"){}else{if(field==="ims"){}else{if(field==="organizations"){c[ContactFindOptions.SEARCH_FIELD_ORGANIZATION_NAME]=true}else{if(field==="birthday"){}else{if(field==="note"){}else{if(field==="photos"){}else{if(field==="categories"){}else{if(field==="urls"){}}}}}}}}}}}}}}for(d in c){if(c.hasOwnProperty(d)){f.push(window.parseInt(d))}}return f}function convertBirthday(a){var b;if(a){b=a.split("-");return new Date(b[0],b[1]-1,b[2]).getTime()}else{return null}}function processJnextSaveData(a,b){var c=b,d;if(c._success===true){c.birthday=convertBirthday(c.birthday);a.callbackOk(c,false)}else{a.callbackError(c.code,false)}}function processJnextRemoveData(a,b){var c=b;if(c._success===true){a.callbackOk(c)}else{a.callbackError(ContactError.UNKNOWN_ERROR,false)}}function processJnextFindData(a,b,f){var d=f,e,c,g=false,h={},j;if(d.contacts){for(e=0,c=d.contacts.length;e<c;e++){d.contacts[e].birthday=convertBirthday(d.contacts[e].birthday);d.contacts[e].name=new ContactName(d.contacts[e].name)}}else{d.contacts=[]}if(d._success===true){b.error=false}if(b.multiple){for(e=0,c=b.searchResult.length;e<c;e++){h[b.searchResult[e].id]=true}for(e=0,c=d.contacts.length;e<c;e++){if(h[d.contacts[e].id]){}else{b.searchResult.push(d.contacts[e])}}b.searchFieldIndex++;if(b.searchFieldIndex<b.searchFields.length){g=true}}else{b.searchResult=d.contacts}if(g){pimContacts.getInstance().invokeJnextSearch(a)}else{if(b.error){b.result.callbackError(d.code,false)}else{b.result.callbackOk(b.searchResult,false)}}}module.exports={search:function(f,b,c,e){var g={},a=new PluginResult(c,e),d;for(d in c){if(c.hasOwnProperty(d)){g[d]=JSON.parse(decodeURIComponent(c[d]))}}pimContacts.getInstance().find(g,a,processJnextFindData);a.noResult(true)},save:function(h,b,e,g){var d={},a=new PluginResult(e,g),f,c=[];d=JSON.parse(decodeURIComponent(e[0]));if(d.birthday){d.birthday=new Date(d.birthday).toDateString()}if(d.emails){d.emails.forEach(function(i){if(i.value){if(i.type){c.push({type:i.type,value:i.value})}else{c.push({type:"home",value:i.value})}}});d.emails=c}if(d.id!==null){d.id=window.parseInt(d.id)}d._eventId=a.callbackId;pimContacts.getInstance().save(d,a,processJnextSaveData);a.noResult(true)},remove:function(f,b,d,e){var a=new PluginResult(d,e),c={contactId:window.parseInt(JSON.parse(decodeURIComponent(d[0]))),_eventId:a.callbackId};if(!window.isNaN(c.contactId)){pimContacts.getInstance().remove(c,a,processJnextRemoveData);a.noResult(true)}else{a.error(ContactError.UNKNOWN_ERROR);a.noResult(false)}}};JNEXT.PimContacts=function(){var a=this,b=false;a.find=function(e,c,d){a.eventHandlers[e.callbackId]={result:c,action:"find",multiple:e[1].filter?true:false,fields:e[0],searchFilter:e[1].filter,searchFields:e[1].filter?populateSearchFields(e[0]):null,searchFieldIndex:0,searchResult:[],handler:d,error:true};a.invokeJnextSearch(e.callbackId);return""};a.invokeJnextSearch=function(d){var c={},e=a.eventHandlers[d];c._eventId=d;c.fields=e.fields;c.options={};c.options.filter=[];if(e.multiple){c.options.filter.push({fieldName:e.searchFields[e.searchFieldIndex],fieldValue:e.searchFilter})}JNEXT.invoke(a.m_id,"find "+JSON.stringify(c))};a.getContact=function(c){return JSON.parse(JNEXT.invoke(a.m_id,"getContact "+JSON.stringify(c)))};a.save=function(c,d,e){a.eventHandlers[c._eventId]={result:d,action:"save",handler:e};JNEXT.invoke(a.m_id,"save "+JSON.stringify(c));return""};a.remove=function(c,d,e){a.eventHandlers[c._eventId]={result:d,action:"remove",handler:e};JNEXT.invoke(a.m_id,"remove "+JSON.stringify(c));return""};a.getId=function(){return a.m_id};a.getContactAccounts=function(){var c=JNEXT.invoke(a.m_id,"getContactAccounts");return JSON.parse(c)};a.init=function(){if(!JNEXT.require("libpimcontacts")){return false}a.m_id=JNEXT.createObject("libpimcontacts.PimContacts");if(a.m_id===""){return false}JNEXT.registerEvents(a)};a.onEvent=function(f){var g=f.split(" "),d=g[0],e,c={};if(d==="result"){c.result=escape(f.split(" ").slice(2).join(" "));e=a.eventHandlers[g[1]];if(e.action==="save"||e.action==="remove"){e.handler(e.result,JSON.parse(decodeURIComponent(c.result)))}else{if(e.action==="find"){e.handler(g[1],e,JSON.parse(decodeURIComponent(c.result)))}}}};a.m_id="";a.eventHandlers={};a.getInstance=function(){if(!b){a.init();b=true}return a}};pimContacts=new JNEXT.PimContacts();