var ContactField=require("./ContactField"),ContactAddress=require("./ContactAddress"),ContactOrganization=require("./ContactOrganization"),ContactName=require("./ContactName"),ContactError=require("./ContactError"),Contact=require("./Contact");function convertToContact(v){var q=new Contact();q.displayName=v.displayName||v.name;q.nickname=v.name;q.id=v.id;q.name=new ContactName(v.displayName||v.name,v.lastName,v.firstName||v.name,v.middleName,v.honorificNamePrefix||v.honorificPrefix,v.honorificNameSuffix||v.honorificSuffix);q.phoneNumbers=[];var u=v.phoneNumbers||v.phones;for(var r=0;r<u.size;r++){var h=u[r];var f=new ContactField(h.category||h.kind,h.value||h.number);q.phoneNumbers.push(f)}q.emails=[];var s=v.emails;for(var r=0;r<s.size;r++){var o=s[r];var n=new ContactField(o.category||o.kind,o.value||o.address);q.emails.push(n)}q.addresses=[];var a=v.locations||v.addresses;for(var r=0;r<a.size;r++){var m=a[r];var e=new ContactAddress(null,m.category||m.kind,m.unstructuredAddress,m.street||m.streetAddress,m.city||m.locality,m.region,m.postalCode,m.country);q.addresses.push(e)}q.ims=[];var l=v.instantMessages||v.connectedServiceAccounts;for(var r=0;r<l.size;r++){var b=l[r];var k=new ContactField(b.category||b.serviceName,b.userName||b.id);q.ims.push(k)}var g=v.jobInfo;if(g){q.organizations=[];for(var p=0;p<g.size;p++){var d=g[r];q.organizations.push(new ContactOrganization(false,null,d.companyName,d.department,d.title))}}var c=v.notes;if(c){q.note=c}var t=v.thumbnail;if(t&&t.path){q.photos=[new ContactField("url",URL.createObjectURL(t),false)]}return q}var contactsNS=Windows.ApplicationModel.Contacts;function cdvContactToWindowsContact(c){var b=new contactsNS.Contact();if(c.name){b.displayNameOverride=c.name.formatted;b.firstName=c.name.givenName;b.middleName=c.name.middleName;b.lastName=c.name.familyName;b.honorificNamePrefix=c.name.honorificPrefix;b.honorificNameSuffix=c.name.honorificSuffix}b.nickname=c.nickname;if(c.phoneNumbers){c.phoneNumbers.forEach(function(e){var i=new contactsNS.ContactPhone();i.description=e.type;i.number=e.value;b.phones.push(i)})}if(c.emails){c.emails.forEach(function(i){var e=new contactsNS.ContactEmail();e.description=i.type;e.address=i.value;b.emails.push(e)})}if(c.addresses){c.addresses.forEach(function(i){var e=new contactsNS.ContactAddress();e.description=i.type;e.streetAddress=i.streetAddress;e.locality=i.locality;e.region=i.region;e.postalCode=i.postalCode;e.country=i.country;b.addresses.push(e)})}if(c.ims){c.ims.forEach(function(e){var i=new contactsNS.ContactConnectedServiceAccount();i.serviceName=e.type;i.id=e.value;b.connectedServiceAccounts.push(i)})}if(c.organizations){c.organizations.forEach(function(i){var e=new contactsNS.ContactJobInfo();e.companyName=i.name;e.department=i.department;e.description=i.type;e.title=i.title;b.jobInfo.push(e)})}b.notes=c.note;if(c.photos){var a=c.photos.filter(function(e){return typeof e.value!=="undefined"});if(a.length>0){var f=a[0];var h=f.value;try{var d;if(/^([a-z][a-z0-9+\-.]*):\/\//i.test(h)){d=Windows.Storage.Streams.RandomAccessStreamReference.createFromUri(new Windows.Foundation.Uri(h))}else{d=Windows.Storage.Streams.RandomAccessStreamReference.createFromFile(h)}b.thumbnail=d}catch(g){}}}return b}module.exports={pickContact:function(f,a,d){var e=navigator.userAgent.indexOf("Windows Phone")!==-1;var c=new contactsNS.ContactPicker();if(e){c.desiredFieldsWithContactFieldType.append(Windows.ApplicationModel.Contacts.ContactFieldType.phoneNumber)}var b=c.pickContactAsync?c.pickContactAsync():c.pickSingleContactAsync();b.done(function(g){if(!g){var h=new ContactError(ContactError.OPERATION_CANCELLED_ERROR);h.message="User did not pick a contact.";a(h);return}if(!e){f(convertToContact(g));return}contactsNS.ContactManager.requestStoreAsync().done(function(i){i.getContactAsync(g.id).done(function(j){f(convertToContact(j))},function(){a(new ContactError(ContactError.UNKNOWN_ERROR))})},function(){a(new ContactError(ContactError.UNKNOWN_ERROR))})})},save:function(d,a,b){if(typeof contactsNS.ContactList==="undefined"){a&&a(ContactError.NOT_SUPPORTED_ERROR);return}var c=cdvContactToWindowsContact(b[0]);contactsNS.ContactManager.requestStoreAsync(contactsNS.ContactStoreAccessType.appContactsReadWrite).then(function(e){return e.findContactListsAsync().then(function(f){if(f.length>0){return f[0]}else{return e.createContactListAsync("")}},function(f){return e.createContactListAsync("")})}).then(function(e){return e.saveContactAsync(c)}).done(function(e){d(convertToContact(c))},function(e){a(e)})},remove:function(c,a,b){if(typeof contactsNS.ContactList==="undefined"){a&&a(ContactError.NOT_SUPPORTED_ERROR);return}WinJS.Promise.join([contactsNS.ContactManager.requestStoreAsync(contactsNS.ContactStoreAccessType.appContactsReadWrite),contactsNS.ContactManager.requestStoreAsync(contactsNS.ContactStoreAccessType.allContactsReadOnly)]).then(function(e){var f=e[1];var d=e[0];var g=d.getContactReader();return g.readBatchAsync().then(function(h){if(h.status!==contactsNS.ContactBatchStatus.success){throw new ContactError(ContactError.IO_ERROR)}var i=h.contacts.filter(function(j){return j.id===b[0]});if(i.length===0){throw new ContactError(ContactError.IO_ERROR)}return i[0]}).then(function(h){return f.aggregateContactManager.findRawContactsAsync(h)}).then(function(h){return d.findContactListsAsync().then(function(j){var l=null;var k=null;var i=j.some(function(n){for(var m=0;m<h.length;m++){if(h[m].contactListId===n.id){l=n;k=h[m];return true}}return false});if(!i){throw new ContactError(ContactError.IO_ERROR)}return l.deleteContactAsync(k)})})}).done(function(){c()},function(d){a(d)})},search:function(g,b,d){var h=d[0],e=d[1],c=e.filter,f=e&&e.multiple;if(!(contactsNS.ContactManager&&contactsNS.ContactManager.requestStoreAsync)){b(new ContactError(ContactError.NOT_SUPPORTED_ERROR));return}var a=contactsNS.ContactManager.requestStoreAsync();a.done(function(i){var j=c?i.findContactsAsync(c):i.findContactsAsync();j.done(function(m){var l=[];if(m.size!==0){var k=f?m:[m[0]];k.forEach(function(n){l.push(convertToContact(n))})}g(l)},function(){b(new ContactError(ContactError.UNKNOWN_ERROR))})},function(){b(new ContactError(ContactError.UNKNOWN_ERROR))})}};require("cordova/exec/proxy").add("Contacts",module.exports);