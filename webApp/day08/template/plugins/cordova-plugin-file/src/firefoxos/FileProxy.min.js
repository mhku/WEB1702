var LocalFileSystem=require("./LocalFileSystem"),FileSystem=require("./FileSystem"),FileEntry=require("./FileEntry"),FileError=require("./FileError"),DirectoryEntry=require("./DirectoryEntry"),File=require("./File");(function(i,d){var h=d.indexedDB||d.mozIndexedDB;if(!h){throw"Firefox OS File plugin: indexedDB not supported"}var b=null;var f={};f.db=null;var n="entries";var e="/";var g=String.fromCharCode(e.charCodeAt(0)+1);var a={applicationDirectory:location.origin+"/",dataDirectory:"file:///persistent/",cacheDirectory:"file:///temporary/"};i.requestFileSystem=function(o,q,s){var u=s[0];if(u!==LocalFileSystem.TEMPORARY&&u!==LocalFileSystem.PERSISTENT){if(q){q(FileError.INVALID_MODIFICATION_ERR)}return}var r=u===LocalFileSystem.TEMPORARY?"temporary":"persistent";var t=(location.protocol+location.host).replace(/:/g,"_");var p=new DirectoryEntry("",e);b=new FileSystem(r,p);f.open(t,function(){o(b)},q)};require("./fileSystems").getFs=function(o,p){p(new FileSystem(o,b.root))};i.readEntries=function(o,p,r){var q=r[0];if(!o){throw Error("Expected successCallback argument.")}var s=l(q);f.getAllEntries(s.fullPath,s.storagePath,function(t){o(t)},p)};i.getFile=function(o,p,s){var r=s[0];var t=s[1];var q=s[2]||{};t=l(r,t);f.get(t.storagePath,function(v){if(q.create===true&&q.exclusive===true&&v){if(p){p(FileError.PATH_EXISTS_ERR)}}else{if(q.create===true&&!v){var u=new FileEntry(t.fileName,t.fullPath,new FileSystem(t.fsName,b.root));u.file_=new k({size:0,name:u.name,lastModifiedDate:new Date(),storagePath:t.storagePath});f.put(u,t.storagePath,o,p)}else{if(q.create===true&&v){if(v.isFile){f["delete"](t.storagePath,function(){var w=new FileEntry(t.fileName,t.fullPath,new FileSystem(t.fsName,b.root));w.file_=new k({size:0,name:w.name,lastModifiedDate:new Date(),storagePath:t.storagePath});f.put(w,t.storagePath,o,p)},p)}else{if(p){p(FileError.INVALID_MODIFICATION_ERR)}}}else{if((!q.create||q.create===false)&&!v){if(p){p(FileError.NOT_FOUND_ERR)}}else{if((!q.create||q.create===false)&&v&&v.isDirectory){if(p){p(FileError.INVALID_MODIFICATION_ERR)}}else{o(c(v))}}}}}},p)};i.getFileMetadata=function(o,p,r){var q=r[0];i.getFile(function(s){o(new File(s.file_.name,s.fullPath,"",s.file_.lastModifiedDate,s.file_.size))},p,[q,null])};i.getMetadata=function(o,p,q){i.getFile(function(r){o({modificationTime:r.file_.lastModifiedDate,size:r.file_.lastModifiedDate})},p,q)};i.setMetadata=function(o,p,s){var r=s[0];var q=s[1];i.getFile(function(t){t.file_.lastModifiedDate=q.modificationTime},p,[r,null])};i.write=function(p,q,r){var t=r[0],s=r[1],o=r[2];if(!s){if(q){q(FileError.INVALID_MODIFICATION_ERR)}return}i.getFile(function(y){var x=y.file_.blob_;if(!x){x=new Blob([s],{type:s.type})}else{var v=x.slice(0,o);var u=x.slice(o+s.byteLength);var w=o-v.size;if(w<0){w=0}x=new Blob([v,new Uint8Array(w),s,u],{type:s.type})}y.file_.blob_=x;y.file_.lastModifiedDate=s.lastModifiedDate||null;y.file_.size=x.size;y.file_.name=x.name;y.file_.type=x.type;f.put(y,y.file_.storagePath,function(){p(s.byteLength)},q)},q,[t,null])};i.readAsText=function(o,q,t){var u=t[0],p=t[1],s=t[2],r=t[3];m("text",u,p,s,r,o,q)};i.readAsDataURL=function(o,p,s){var t=s[0],r=s[1],q=s[2];m("dataURL",t,null,r,q,o,p)};i.readAsBinaryString=function(o,p,s){var t=s[0],r=s[1],q=s[2];m("binaryString",t,null,r,q,o,p)};i.readAsArrayBuffer=function(o,p,s){var t=s[0],r=s[1],q=s[2];m("arrayBuffer",t,null,r,q,o,p)};i.removeRecursively=i.remove=function(o,p,r){var q=r[0];f["delete"](q,function(){o()},p)};i.getDirectory=function(o,p,s){var r=s[0];var t=s[1];var q=s[2];t=l(r,t);f.get(t.storagePath,function(v){if(!q){q={}}if(q.create===true&&q.exclusive===true&&v){if(p){p(FileError.INVALID_MODIFICATION_ERR)}}else{if(q.create===true&&!v){var u=new DirectoryEntry(t.fileName,t.fullPath,new FileSystem(t.fsName,b.root));f.put(u,t.storagePath,o,p)}else{if(q.create===true&&v){if(v.isDirectory){o(new DirectoryEntry(v.name,v.fullPath,v.fileSystem))}else{if(p){p(FileError.INVALID_MODIFICATION_ERR)}}}else{if((!q.create||q.create===false)&&!v){if(t.fullPath===e){o(b.root);return}if(p){p(FileError.NOT_FOUND_ERR)}}else{if((!q.create||q.create===false)&&v&&v.isFile){if(p){p(FileError.INVALID_MODIFICATION_ERR)}}else{o(new DirectoryEntry(v.name,v.fullPath,v.fileSystem))}}}}}},p)};i.getParent=function(o,p,r){var q=r[0];if(q===e){o(b.root);return}var t=q.split(e);t.pop();var s=t.pop();var u=t.join(e);i.getDirectory(o,p,[u,s,{create:false}])};i.copyTo=function(o,q,s){var t=s[0];var p=s[1];var r=s[2];i.getFile(function(u){i.getFile(function(v){i.write(function(){o(v)},q,[v.file_.storagePath,u.file_.blob_,0])},q,[p,r,{create:true}])},q,[t,null])};i.moveTo=function(o,p,q){var r=q[0];i.copyTo(function(s){i.remove(function(){o(s)},p,[r])},p,q)};i.resolveLocalFileSystemURI=function(o,p,q){var s=q[0];if(s.indexOf("?")!==-1){s=String(s).split("?")[0]}if(/\%5/g.test(s)){s=decodeURI(s)}if(s.indexOf(a.dataDirectory)===0){s=s.substring(a.dataDirectory.length-1);i.requestFileSystem(function(u){u.root.getFile(s,{create:false},o,function(){u.root.getDirectory(s,{create:false},o,p)})},p,[LocalFileSystem.PERSISTENT])}else{if(s.indexOf(a.cacheDirectory)===0){s=s.substring(a.cacheDirectory.length-1);i.requestFileSystem(function(u){u.root.getFile(s,{create:false},o,function(){u.root.getDirectory(s,{create:false},o,p)})},p,[LocalFileSystem.TEMPORARY])}else{if(s.indexOf(a.applicationDirectory)===0){s=s.substring(a.applicationDirectory.length);var t=new XMLHttpRequest();t.open("GET",s,true);t.onreadystatechange=function(){if(t.status===200&&t.readyState===4){i.requestFileSystem(function(u){u.name=location.hostname;u.root.getFile(s,{create:true},r,p)},p,[LocalFileSystem.PERSISTENT])}};t.onerror=function(){if(p){p(FileError.NOT_READABLE_ERR)}};t.send()}else{if(p){p(FileError.NOT_FOUND_ERR)}}}}function r(u){u.createWriter(function(v){v.onwriteend=function(w){if(!w.target.error){u.filesystemName=location.hostname;o(u)}};v.onerror=function(){if(p){p(FileError.NOT_READABLE_ERR)}};v.write(new Blob([t.response]))},p)}};i.requestAllPaths=function(o){o(a)};function k(o){var p=new Blob();this.size=o.size||0;this.name=o.name||"";this.type=o.type||"";this.lastModifiedDate=o.lastModifiedDate||null;this.storagePath=o.storagePath||"";Object.defineProperty(this,"blob_",{enumerable:true,get:function(){return p},set:function(q){p=q;this.size=p.size;this.name=p.name;this.type=p.type;this.lastModifiedDate=p.lastModifiedDate}.bind(this)})}k.prototype.constructor=k;function l(v,u){u=u||"";var q=u;var s="";v=v||e;if(v.indexOf(FILESYSTEM_PREFIX)===0){s=v.substring(0,v.indexOf(e,FILESYSTEM_PREFIX.length));v=v.substring(v.indexOf(e,FILESYSTEM_PREFIX.length))}var o=u[0]!==e;if(o){q=v;if(v!=e){q+=e+u}else{q+=u}}var t=q.split(e);for(var r=0;r<t.length;++r){var p=t[r];if(p==".."){t[r-1]="";t[r]=""}}q=t.filter(function(w){return w}).join(e);if(q[0]!==e){q=e+q}q=q.replace(/\.\//g,e);q=q.replace(/\/\//g,e);q=q.replace(/\/\./g,e);if(q[q.length-1]==e&&q!=e){q=q.substring(0,q.length-1)}return{storagePath:s+q,fullPath:q,fileName:q.split(e).pop(),fsName:s.split(e).pop()}}function c(p){var o=new FileEntry(p.name,p.fullPath,p.fileSystem);o.file_=p.file_;return o}function m(u,s,t,r,q,o,p){i.getFile(function(x){var v=new FileReader(),w=x.file_.blob_.slice(r,q);v.onload=function(y){o(y.target.result)};v.onerror=p;switch(u){case"text":v.readAsText(w,t);break;case"dataURL":v.readAsDataURL(w);break;case"arrayBuffer":v.readAsArrayBuffer(w);break;case"binaryString":v.readAsBinaryString(w);break}},p,[s,null])}f.open=function(s,o,q){var p=this;var r=h.open(s.replace(":","_"));r.onerror=q||j;r.onupgradeneeded=function(t){p.db=t.target.result;p.db.onerror=j;if(!p.db.objectStoreNames.contains(n)){p.db.createObjectStore(n)}};r.onsuccess=function(t){p.db=t.target.result;p.db.onerror=j;o(t)};r.onblocked=q||j};f.close=function(){this.db.close();this.db=null};f.get=function(s,o,r){if(!this.db){if(r){r(FileError.INVALID_MODIFICATION_ERR)}return}var p=this.db.transaction([n],"readonly");var q=IDBKeyRange.bound(s,s+g,false,true);var t=p.objectStore(n).get(q);p.onabort=r||j;p.oncomplete=function(u){o(t.result)}};f.getAllEntries=function(s,v,o,r){if(!this.db){if(r){r(FileError.INVALID_MODIFICATION_ERR)}return}var t=[];if(v[v.length-1]===e){v=v.substring(0,v.length-1)}var q=IDBKeyRange.bound(v+e,v+g,false,true);var p=this.db.transaction([n],"readonly");p.onabort=r||j;p.oncomplete=function(w){t=t.filter(function(z){var y=z.fullPath.split(e).length;var x=s.split(e).length;if(s===e&&y<x+1){return z}else{if(s!==e&&y===x+1){return z}}});o(t)};var u=p.objectStore(n).openCursor(q);u.onsuccess=function(w){var y=w.target.result;if(y){var x=y.value;t.push(x.isFile?c(x):new DirectoryEntry(x.name,x.fullPath,x.fileSystem));y["continue"]()}}};f["delete"]=function(s,o,r){if(!this.db){if(r){r(FileError.INVALID_MODIFICATION_ERR)}return}var p=this.db.transaction([n],"readwrite");p.oncomplete=o;p.onabort=r||j;var q=IDBKeyRange.bound(s,s+g,false,true);p.objectStore(n)["delete"](q)};f.put=function(r,s,o,q){if(!this.db){if(q){q(FileError.INVALID_MODIFICATION_ERR)}return}var p=this.db.transaction([n],"readwrite");p.onabort=q||j;p.oncomplete=function(t){o(r)};p.objectStore(n).put(r,s)};function j(o){switch(o.target.errorCode){case 12:console.log("Error - Attempt to open db with a lower version than the current one.");break;default:console.log("errorCode: "+o.target.errorCode)}console.log(o,o.code,o.message)}})(module.exports,window);require("cordova/exec/proxy").add("File",module.exports);