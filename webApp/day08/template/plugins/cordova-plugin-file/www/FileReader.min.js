var exec=require("cordova/exec"),modulemapper=require("cordova/modulemapper"),utils=require("cordova/utils"),FileError=require("./FileError"),ProgressEvent=require("./ProgressEvent"),origFileReader=modulemapper.getOriginalSymbol(window,"FileReader");var FileReader=function(){this._readyState=0;this._error=null;this._result=null;this._progress=null;this._localURL="";this._realReader=origFileReader?new origFileReader():{}};FileReader.READ_CHUNK_SIZE=256*1024;FileReader.EMPTY=0;FileReader.LOADING=1;FileReader.DONE=2;utils.defineGetter(FileReader.prototype,"readyState",function(){return this._localURL?this._readyState:this._realReader.readyState});utils.defineGetter(FileReader.prototype,"error",function(){return this._localURL?this._error:this._realReader.error});utils.defineGetter(FileReader.prototype,"result",function(){return this._localURL?this._result:this._realReader.result});function defineEvent(a){utils.defineGetterSetter(FileReader.prototype,a,function(){return this._realReader[a]||null},function(b){this._realReader[a]=b})}defineEvent("onloadstart");defineEvent("onprogress");defineEvent("onload");defineEvent("onerror");defineEvent("onloadend");defineEvent("onabort");function initRead(a,b){if(a.readyState==FileReader.LOADING){throw new FileError(FileError.INVALID_STATE_ERR)}a._result=null;a._error=null;a._progress=0;a._readyState=FileReader.LOADING;if(typeof b.localURL=="string"){a._localURL=b.localURL}else{a._localURL="";return true}if(a.onloadstart){a.onloadstart(new ProgressEvent("loadstart",{target:a}))}}function readSuccessCallback(c,f,g,b,a,e){if(this._readyState===FileReader.DONE){return}if(typeof e!=="undefined"){a(e);this._progress=Math.min(this._progress+FileReader.READ_CHUNK_SIZE,b);if(typeof this.onprogress==="function"){this.onprogress(new ProgressEvent("progress",{loaded:this._progress,total:b}))}}if(typeof e==="undefined"||this._progress<b){var d=[this._localURL,g+this._progress,g+this._progress+Math.min(b-this._progress,FileReader.READ_CHUNK_SIZE)];if(f){d.splice(1,0,f)}exec(readSuccessCallback.bind(this,c,f,g,b,a),readFailureCallback.bind(this),"File",c,d)}else{this._readyState=FileReader.DONE;if(typeof this.onload==="function"){this.onload(new ProgressEvent("load",{target:this}))}if(typeof this.onloadend==="function"){this.onloadend(new ProgressEvent("loadend",{target:this}))}}}function readFailureCallback(a){if(this._readyState===FileReader.DONE){return}this._readyState=FileReader.DONE;this._result=null;this._error=new FileError(a);if(typeof this.onerror==="function"){this.onerror(new ProgressEvent("error",{target:this}))}if(typeof this.onloadend==="function"){this.onloadend(new ProgressEvent("loadend",{target:this}))}}FileReader.prototype.abort=function(){if(origFileReader&&!this._localURL){return this._realReader.abort()}this._result=null;if(this._readyState==FileReader.DONE||this._readyState==FileReader.EMPTY){return}this._readyState=FileReader.DONE;if(typeof this.onabort==="function"){this.onabort(new ProgressEvent("abort",{target:this}))}if(typeof this.onloadend==="function"){this.onloadend(new ProgressEvent("loadend",{target:this}))}};FileReader.prototype.readAsText=function(c,d){if(initRead(this,c)){return this._realReader.readAsText(c,d)}var b=d?d:"UTF-8";var a=c.end-c.start;readSuccessCallback.bind(this)("readAsText",b,c.start,a,function(e){if(this._progress===0){this._result=""}this._result+=e}.bind(this))};FileReader.prototype.readAsDataURL=function(b){if(initRead(this,b)){return this._realReader.readAsDataURL(b)}var a=b.end-b.start;readSuccessCallback.bind(this)("readAsDataURL",null,b.start,a,function(c){var d=c.indexOf(",");if(this._progress===0){this._result=c}else{this._result+=c.substring(d+1)}}.bind(this))};FileReader.prototype.readAsBinaryString=function(b){if(initRead(this,b)){return this._realReader.readAsBinaryString(b)}var a=b.end-b.start;readSuccessCallback.bind(this)("readAsBinaryString",null,b.start,a,function(c){if(this._progress===0){this._result=""}this._result+=c}.bind(this))};FileReader.prototype.readAsArrayBuffer=function(b){if(initRead(this,b)){return this._realReader.readAsArrayBuffer(b)}var a=b.end-b.start;readSuccessCallback.bind(this)("readAsArrayBuffer",null,b.start,a,function(c){var d=(this._progress===0?new Uint8Array(a):new Uint8Array(this._result));d.set(new Uint8Array(c),this._progress);this._result=d.buffer}.bind(this))};module.exports=FileReader;