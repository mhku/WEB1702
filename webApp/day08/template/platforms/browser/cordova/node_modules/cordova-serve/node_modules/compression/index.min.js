/*!
 * compression
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var accepts=require("accepts");var bytes=require("bytes");var compressible=require("compressible");var debug=require("debug")("compression");var onHeaders=require("on-headers");var vary=require("vary");var zlib=require("zlib");module.exports=compression;module.exports.filter=shouldCompress;var cacheControlNoTransformRegExp=/(?:^|,)\s*?no-transform\s*?(?:,|$)/;function compression(c){var e=c||{};var d=e.filter||shouldCompress;var a=bytes.parse(e.threshold);if(a==null){a=1024}return function b(m,k,h){var n=false;var f;var l=[];var q=k.write;var i=k.on;var g=k.end;var p;k.flush=function o(){if(p){p.flush()}};k.write=function(r,s){if(n){return false}if(!this._header){this._implicitHeader()}return p?p.write(new Buffer(r,s)):q.call(this,r,s)};k.end=function(r,s){if(n){return false}if(!this._header){if(!this.getHeader("Content-Length")){f=chunkLength(r,s)}this._implicitHeader()}if(!p){return g.call(this,r,s)}n=true;return r?p.end(new Buffer(r,s)):p.end()};k.on=function(r,s){if(!l||r!=="drain"){return i.call(this,r,s)}if(p){return p.on(r,s)}l.push([r,s]);return this};function j(r){debug("no compression: %s",r);addListeners(k,i,l);l=null}onHeaders(k,function(){if(!d(m,k)){j("filtered");return}if(!shouldTransform(m,k)){j("no transform");return}vary(k,"Accept-Encoding");if(Number(k.getHeader("Content-Length"))<a||f<a){j("size below threshold");return}var s=k.getHeader("Content-Encoding")||"identity";if("identity"!==s){j("already encoded");return}if("HEAD"===m.method){j("HEAD request");return}var r=accepts(m);var t=r.encoding(["gzip","deflate","identity"]);if(t==="deflate"&&r.encoding(["gzip"])){t=r.encoding(["gzip","identity"])}if(!t||t==="identity"){j("not acceptable");return}debug("%s compression",t);p=t==="gzip"?zlib.createGzip(e):zlib.createDeflate(e);addListeners(p,p.on,l);k.setHeader("Content-Encoding",t);k.removeHeader("Content-Length");p.on("data",function(u){if(q.call(k,u)===false){p.pause()}});p.on("end",function(){g.call(k)});i.call(k,"drain",function(){p.resume()})});h()}}function addListeners(d,a,c){for(var b=0;b<c.length;b++){a.apply(d,c[b])}}function chunkLength(a,b){if(!a){return 0}return !Buffer.isBuffer(a)?Buffer.byteLength(a,b):a.length}function shouldCompress(c,a){var b=a.getHeader("Content-Type");if(b===undefined||!compressible(b)){debug("%s not compressible",b);return false}return true}function shouldTransform(c,b){var a=b.getHeader("Cache-Control");return !a||!cacheControlNoTransformRegExp.test(a)};