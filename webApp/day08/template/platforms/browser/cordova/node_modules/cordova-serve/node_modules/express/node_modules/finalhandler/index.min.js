/*!
 * finalhandler
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var debug=require("debug")("finalhandler");var escapeHtml=require("escape-html");var http=require("http");var onFinished=require("on-finished");var unpipe=require("unpipe");var defer=typeof setImmediate==="function"?setImmediate:function(a){process.nextTick(a.bind.apply(a,arguments))};var isFinished=onFinished.isFinished;module.exports=finalhandler;function finalhandler(f,c,b){var e=b||{};var d=e.env||process.env.NODE_ENV||"development";var a=e.onerror;return function(h){var g=c.statusCode;if(!h&&c._header){debug("cannot 404 after headers sent");return}if(h){if(h.statusCode){g=h.statusCode}if(h.status){g=h.status}if(!g||g<400){g=500}var i=d==="production"?http.STATUS_CODES[g]:h.stack||h.toString();i=escapeHtml(i).replace(/\n/g,"<br>").replace(/  /g," &nbsp;")+"\n"}else{g=404;i="Cannot "+escapeHtml(f.method)+" "+escapeHtml(f.originalUrl||f.url)+"\n"}debug("default %s",g);if(h&&a){defer(a,h,f,c)}if(c._header){return f.socket.destroy()}send(f,c,g,i)}}function send(e,c,b,a){function d(){c.statusCode=b;c.setHeader("X-Content-Type-Options","nosniff");c.setHeader("Content-Type","text/html; charset=utf-8");c.setHeader("Content-Length",Buffer.byteLength(a,"utf8"));if(e.method==="HEAD"){c.end();return}c.end(a,"utf8")}if(isFinished(e)){d();return}unpipe(e);onFinished(e,d);e.resume()};