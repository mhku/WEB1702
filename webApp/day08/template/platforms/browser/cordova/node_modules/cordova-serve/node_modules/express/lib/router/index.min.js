/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var Route=require("./route");var Layer=require("./layer");var methods=require("methods");var mixin=require("utils-merge");var debug=require("debug")("express:router");var deprecate=require("depd")("express");var flatten=require("array-flatten");var parseUrl=require("parseurl");var objectRegExp=/^\[object (\S+)\]$/;var slice=Array.prototype.slice;var toString=Object.prototype.toString;var proto=module.exports=function(b){var c=b||{};function a(f,d,e){a.handle(f,d,e)}a.__proto__=proto;a.params={};a._params=[];a.caseSensitive=c.caseSensitive;a.mergeParams=c.mergeParams;a.strict=c.strict;a.stack=[];return a};proto.param=function param(c,e){if(typeof c==="function"){deprecate("router.param(fn): Refactor to use path params");this._params.push(c);return}var f=this._params;var a=f.length;var b;if(c[0]===":"){deprecate("router.param("+JSON.stringify(c)+", fn): Use router.param("+JSON.stringify(c.substr(1))+", fn) instead");c=c.substr(1)}for(var d=0;d<a;++d){if(b=f[d](c,e)){e=b}}if("function"!=typeof e){throw new Error("invalid param() call for "+c+", got "+e)}(this.params[c]=this.params[c]||[]).push(e);return this};proto.handle=function handle(a,r,n){var k=this;debug("dispatching %s %s",a.method,a.url);var i=1+a.url.indexOf("?");var p=i?i-1:a.url.length;var f=a.url[0]!=="/"&&1+a.url.substr(0,p).indexOf("://");var q=f?a.url.substr(0,a.url.indexOf("/",2+f)):"";var j=0;var o="";var c=false;var h={};var b=[];var d=k.stack;var g=a.params;var s=a.baseUrl||"";var l=restore(n,a,"baseUrl","next","params");a.next=m;if(a.method==="OPTIONS"){l=wrap(l,function(t,u){if(u||b.length===0){return t(u)}sendOptionsResponse(r,b,t)})}a.baseUrl=s;a.originalUrl=a.originalUrl||a.url;m();function m(u){var z=u==="route"?null:u;if(c){a.url=a.url.substr(1);c=false}if(o.length!==0){a.baseUrl=s;a.url=q+o+a.url.substr(q.length);o=""}if(j>=d.length){setImmediate(l,z);return}var B=getPathname(a);if(B==null){return l(z)}var x;var w;var A;while(w!==true&&j<d.length){x=d[j++];w=matchLayer(x,B);A=x.route;if(typeof w!=="boolean"){z=z||w}if(w!==true){continue}if(!A){continue}if(z){w=false;continue}var t=a.method;var y=A._handles_method(t);if(!y&&t==="OPTIONS"){appendMethods(b,A._options())}if(!y&&t!=="HEAD"){w=false;continue}}if(w!==true){return l(z)}if(A){a.route=A}a.params=k.mergeParams?mergeParams(x.params,g):x.params;var v=x.path;k.process_params(x,h,a,r,function(C){if(C){return m(z||C)}if(A){return x.handle_request(a,r,m)}e(x,z,v,B)})}function e(u,t,w,v){var x=v[w.length];if(x&&"/"!==x&&"."!==x){return m(t)}if(w.length!==0){debug("trim prefix (%s) from url %s",w,a.url);o=w;a.url=q+a.url.substr(q.length+o.length);if(!f&&a.url[0]!=="/"){a.url="/"+a.url;c=true}a.baseUrl=s+(o[o.length-1]==="/"?o.substring(0,o.length-1):o)}debug("%s %s : %s",u.name,w,a.originalUrl);if(t){u.handle_error(t,a,r,m)}else{u.handle_request(a,r,m)}}};proto.process_params=function process_params(g,m,k,j,e){var c=this.params;var p=g.keys;if(!p||p.length===0){return e()}var f=0;var a;var q=0;var o;var n;var l;var h;function b(i){if(i){return e(i)}if(f>=p.length){return e()}q=0;o=p[f++];if(!o){return e()}a=o.name;n=k.params[a];l=c[a];h=m[a];if(n===undefined||!l){return b()}if(h&&(h.match===n||(h.error&&h.error!=="route"))){k.params[a]=h.value;return b(h.error)}m[a]=h={error:null,match:n,value:n};d()}function d(r){var i=l[q++];h.value=k.params[o.name];if(r){h.error=r;b(r);return}if(!i){return b()}try{i(k,j,d,n,o.name)}catch(s){d(s)}}b()};proto.use=function use(d){var g=0;var f="/";if(typeof d!=="function"){var a=d;while(Array.isArray(a)&&a.length!==0){a=a[0]}if(typeof a!=="function"){g=1;f=d}}var e=flatten(slice.call(arguments,g));if(e.length===0){throw new TypeError("Router.use() requires middleware functions")}for(var c=0;c<e.length;c++){var d=e[c];if(typeof d!=="function"){throw new TypeError("Router.use() requires middleware function but got a "+gettype(d))}debug("use %s %s",f,d.name||"<anonymous>");var b=new Layer(f,{sensitive:this.caseSensitive,strict:false,end:false},d);b.route=undefined;this.stack.push(b)}return this};proto.route=function route(c){var a=new Route(c);var b=new Layer(c,{sensitive:this.caseSensitive,strict:this.strict,end:true},a.dispatch.bind(a));b.route=a;this.stack.push(b);return a};methods.concat("all").forEach(function(a){proto[a]=function(c){var b=this.route(c);b[a].apply(b,slice.call(arguments,1));return this}});function appendMethods(c,a){for(var b=0;b<a.length;b++){var d=a[b];if(c.indexOf(d)===-1){c.push(d)}}}function getPathname(b){try{return parseUrl(b).pathname}catch(a){return undefined}}function gettype(b){var a=typeof b;if(a!=="object"){return a}return toString.call(b).replace(objectRegExp,"$1")}function matchLayer(a,c){try{return a.match(c)}catch(b){return b}}function mergeParams(e,b){if(typeof b!=="object"||!b){return e}var c=mixin({},b);if(!(0 in e)||!(0 in b)){return mixin(c,e)}var a=0;var d=0;while(a in e){a++}while(d in b){d++}for(a--;a>=0;a--){e[a+d]=e[a];if(a<d){delete e[a]}}return mixin(c,e)}function restore(c,e){var b=new Array(arguments.length-2);var d=new Array(arguments.length-2);for(var a=0;a<b.length;a++){b[a]=arguments[a+2];d[a]=e[b[a]]}return function(g){for(var f=0;f<b.length;f++){e[b[f]]=d[f]}return c.apply(this,arguments)}}function sendOptionsResponse(c,b,d){try{var a=b.join(",");c.set("Allow",a);c.send(a)}catch(e){d(e)}}function wrap(a,c){return function b(){var e=new Array(arguments.length+1);e[0]=a;for(var f=0,d=arguments.length;f<d;f++){e[f+1]=arguments[f]}c.apply(this,e)}};