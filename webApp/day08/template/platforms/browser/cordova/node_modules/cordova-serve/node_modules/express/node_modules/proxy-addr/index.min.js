/*!
 * proxy-addr
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";module.exports=proxyaddr;module.exports.all=alladdrs;module.exports.compile=compile;var forwarded=require("forwarded");var ipaddr=require("ipaddr.js");var digitre=/^[0-9]+$/;var isip=ipaddr.isValid;var parseip=ipaddr.parse;var ipranges={linklocal:["169.254.0.0/16","fe80::/10"],loopback:["127.0.0.1/8","::1/128"],uniquelocal:["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","fc00::/7"]};function alladdrs(c,d){var b=forwarded(c);if(!d){return b}if(typeof d!=="function"){d=compile(d)}for(var a=0;a<b.length-1;a++){if(d(b[a],a)){continue}b.length=a+1}return b}function compile(b){if(!b){throw new TypeError("argument is required")}var c=typeof b==="string"?[b]:b;if(!Array.isArray(c)){throw new TypeError("unsupported trust argument")}for(var a=0;a<c.length;a++){b=c[a];if(!ipranges.hasOwnProperty(b)){continue}b=ipranges[b];c.splice.apply(c,[a,1].concat(b));a+=b.length-1}return compileTrust(compileRangeSubnets(c))}function compileRangeSubnets(a){var c=new Array(a.length);for(var b=0;b<a.length;b++){c[b]=parseipNotation(a[b])}return c}function compileTrust(b){var a=b.length;return a===0?trustNone:a===1?trustSingle(b[0]):trustMulti(b)}function parseipNotation(d){var e;var c;var a;var f=d.lastIndexOf("/");var b;e=f!==-1?d.substring(0,f):d;if(!isip(e)){throw new TypeError("invalid IP address: "+e)}e=parseip(e);c=e.kind();a=c==="ipv6"?128:32;b=f!==-1?d.substring(f+1,d.length):a;if(typeof b!=="number"){b=digitre.test(b)?parseInt(b,10):isip(b)?parseNetmask(b):0}if(e.kind()==="ipv6"&&e.isIPv4MappedAddress()){e=e.toIPv4Address();b=b<=a?b-96:b}if(b<=0||b>a){throw new TypeError("invalid range on address: "+d)}return[e,b]}function parseNetmask(f){var h=parseip(f);var g;var e;switch(h.kind()){case"ipv4":g=h.octets;e=8;break;case"ipv6":g=h.parts;e=16;break}var a=Math.pow(2,e)-1;var c;var b=0;for(var d=0;d<g.length;d++){c=g[d]&a;if(c===a){b+=e;continue}while(c){c=(c<<1)&a;b+=1}break}return b}function proxyaddr(b,d){if(!b){throw new TypeError("req argument is required")}if(!d){throw new TypeError("trust argument is required")}var a=alladdrs(b,d);var c=a[a.length-1];return c}function trustNone(){return false}function trustMulti(a){return function b(l){if(!isip(l)){return false}var j=parseip(l);var k;var e=j.kind();var d;var m;var c;var h;var g;for(var f=0;f<a.length;f++){d=a[f];m=d[0];c=m.kind();h=d[1];g=j;if(e!==c){if(e!=="ipv6"||c!=="ipv4"||!j.isIPv4MappedAddress()){continue}k=k||j.toIPv4Address();g=k}if(g.match(m,h)){return true}}return false}}function trustSingle(c){var b=c[0];var f=b.kind();var d=f==="ipv4";var a=c[1];return function e(i){if(!isip(i)){return false}var h=parseip(i);var g=h.kind();return g===f?h.match(b,a):d&&g==="ipv6"&&h.isIPv4MappedAddress()?h.toIPv4Address().match(b,a):false}};