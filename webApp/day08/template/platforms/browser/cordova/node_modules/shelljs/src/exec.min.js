var common=require("./common");var _tempDir=require("./tempdir");var _pwd=require("./pwd");var path=require("path");var fs=require("fs");var child=require("child_process");var DEFAULT_MAXBUFFER_SIZE=20*1024*1024;function execSync(n,j){var m=_tempDir();var d=path.resolve(m+"/"+common.randomFileName()),f=path.resolve(m+"/"+common.randomFileName()),h=path.resolve(m+"/"+common.randomFileName()),o=path.resolve(m+"/"+common.randomFileName()),q=path.resolve(m+"/"+common.randomFileName());j=common.extend({silent:common.config.silent,cwd:_pwd(),env:process.env,maxBuffer:DEFAULT_MAXBUFFER_SIZE},j);var c="",b="";function l(v){if(j.silent||!fs.existsSync(v)){return}var w,u;if(v===d){w=c;u=process.stdout}else{w=b;u=process.stderr}var e=fs.readFileSync(v,"utf8");if(e.length<=w.length){return}u.write(e.substr(w.length));w=e}function k(e){return(e+"").replace(/([\\"'])/g,"\\$1").replace(/\0/g,"\\0")}if(fs.existsSync(o)){common.unlinkSync(o)}if(fs.existsSync(d)){common.unlinkSync(d)}if(fs.existsSync(f)){common.unlinkSync(f)}if(fs.existsSync(h)){common.unlinkSync(h)}var p='"'+process.execPath+'" '+o;var t;if(typeof child.execSync==="function"){t=["var child = require('child_process')","  , fs = require('fs');","var childProcess = child.exec('"+k(n)+"', {env: process.env, maxBuffer: "+j.maxBuffer+"}, function(err) {","  fs.writeFileSync('"+k(h)+"', err ? err.code.toString() : '0');","});","var stdoutStream = fs.createWriteStream('"+k(d)+"');","var stderrStream = fs.createWriteStream('"+k(f)+"');","childProcess.stdout.pipe(stdoutStream, {end: false});","childProcess.stderr.pipe(stderrStream, {end: false});","childProcess.stdout.pipe(process.stdout);","childProcess.stderr.pipe(process.stderr);","var stdoutEnded = false, stderrEnded = false;","function tryClosingStdout(){ if(stdoutEnded){ stdoutStream.end(); } }","function tryClosingStderr(){ if(stderrEnded){ stderrStream.end(); } }","childProcess.stdout.on('end', function(){ stdoutEnded = true; tryClosingStdout(); });","childProcess.stderr.on('end', function(){ stderrEnded = true; tryClosingStderr(); });"].join("\n");fs.writeFileSync(o,t);if(j.silent){j.stdio="ignore"}else{j.stdio=[0,1,2]}child.execSync(p,j)}else{n+=" > "+d+" 2> "+f;t=["var child = require('child_process')","  , fs = require('fs');","var childProcess = child.exec('"+k(n)+"', {env: process.env, maxBuffer: "+j.maxBuffer+"}, function(err) {","  fs.writeFileSync('"+k(h)+"', err ? err.code.toString() : '0');","});"].join("\n");fs.writeFileSync(o,t);child.exec(p,j);while(!fs.existsSync(h)){l(d);fs.writeFileSync(q,"a")}while(!fs.existsSync(d)){l(d);fs.writeFileSync(q,"a")}while(!fs.existsSync(f)){l(f);fs.writeFileSync(q,"a")}}var a=parseInt("",10);while(isNaN(a)){a=parseInt(fs.readFileSync(h,"utf8"),10)}var g=fs.readFileSync(d,"utf8");var s=fs.readFileSync(f,"utf8");try{common.unlinkSync(o)}catch(r){}try{common.unlinkSync(d)}catch(r){}try{common.unlinkSync(f)}catch(r){}try{common.unlinkSync(h)}catch(r){}try{common.unlinkSync(q)}catch(r){}if(a===1||a===2||a>=126){common.error("",true)}var i={code:a,output:g,stdout:g,stderr:s};return i}function execAsync(e,d,g){var a="";var b="";d=common.extend({silent:common.config.silent,cwd:_pwd(),env:process.env,maxBuffer:DEFAULT_MAXBUFFER_SIZE},d);var f=child.exec(e,d,function(c){if(g){g(c?c.code:0,a,b)}});f.stdout.on("data",function(c){a+=c;if(!d.silent){process.stdout.write(c)}});f.stderr.on("data",function(c){b+=c;if(!d.silent){process.stderr.write(c)}});return f}function _exec(c,a,d){if(!c){common.error("must specify command")}if(typeof a==="function"){d=a;a={async:true}}if(typeof a==="object"&&typeof d==="function"){a.async=true}a=common.extend({silent:common.config.silent,async:false},a);try{if(a.async){return execAsync(c,a,d)}else{return execSync(c,a)}}catch(b){common.error("internal error")}}module.exports=_exec;