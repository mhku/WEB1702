var os=require("os");var fs=require("fs");var _ls=require("./ls");var config={silent:false,fatal:false,verbose:false};exports.config=config;var state={error:null,currentCmd:"shell.js",previousDir:null,tempDir:null};exports.state=state;var platform=os.type().match(/^Win/)?"win":"unix";exports.platform=platform;function log(){if(!config.silent){console.error.apply(console,arguments)}}exports.log=log;function error(c,a){if(state.error===null){state.error=""}var b=state.currentCmd+": "+c;if(state.error===""){state.error=b}else{state.error+="\n"+b}if(c.length>0){log(b)}if(config.fatal){process.exit(1)}if(!a){throw""}}exports.error=error;function ShellString(a){return a}exports.ShellString=ShellString;function getUserHome(){var a;if(os.homedir){a=os.homedir()}else{a=process.env[(process.platform==="win32")?"USERPROFILE":"HOME"]}return a}exports.getUserHome=getUserHome;function parseOptions(e,h){if(!h){error("parseOptions() internal error: no map given")}var a={};for(var g in h){if(h[g][0]!=="!"){a[h[g]]=false}}if(!e){return a}var d;if(typeof e==="string"){if(e[0]!=="-"){return a}var f=e.slice(1).split("");f.forEach(function(j){if(j in h){d=h[j];if(d[0]==="!"){a[d.slice(1,d.length-1)]=false}else{a[d]=true}}else{error("option not recognized: "+j)}})}else{if(typeof e==="object"){for(var b in e){var i=b[1];if(i in h){d=h[i];a[d]=e[b]}else{error("option not recognized: "+i)}}}else{error("options must be strings or key-value pairs")}}return a}exports.parseOptions=parseOptions;function expand(b){var a=[];b.forEach(function(f){if(f.search(/\*[^\/]*\//)>-1||f.search(/\*\*[^\/]*\//)>-1){var d=f.match(/^([^*]+\/|)(.*)/);var c=d[1];var e=d[2];var g=e.replace(/\*\*/g,".*").replace(/\*/g,"[^\\/]*");g=new RegExp(g);_ls("-R",c).filter(function(h){return g.test(h)}).forEach(function(h){a.push(h)})}else{if(f.search(/\*/)>-1){_ls("",f).forEach(function(h){a.push(h)})}else{a.push(f)}}});return a}exports.expand=expand;function unlinkSync(a){try{fs.unlinkSync(a)}catch(b){if(b.code==="EPERM"){fs.chmodSync(a,"0666");fs.unlinkSync(a)}else{throw b}}}exports.unlinkSync=unlinkSync;function randomFileName(){function a(c){if(c===1){return parseInt(16*Math.random(),10).toString(16)}else{var d="";for(var b=0;b<c;b++){d+=a(1)}return d}}return"shelljs_"+a(20)}exports.randomFileName=randomFileName;function extend(b){var a=[].slice.call(arguments,1);a.forEach(function(d){for(var c in d){b[c]=d[c]}});return b}exports.extend=extend;function wrap(c,b,a){return function(){var h=null;state.currentCmd=c;state.error=null;try{var d=[].slice.call(arguments,0);if(config.verbose){d.unshift(c);console.log.apply(console,d);d.shift()}if(a&&a.notUnix){h=b.apply(this,d)}else{if(typeof d[0]==="object"&&d[0].constructor.name==="Object"){d=d}else{if(d.length===0||typeof d[0]!=="string"||d[0].length<=1||d[0][0]!=="-"){d.unshift("")}}var f=getUserHome();d=d.map(function(e){if(typeof e==="string"&&e.slice(0,2)==="~/"||e==="~"){return e.replace(/^~/,f)}else{return e}});h=b.apply(this,d)}}catch(g){if(!state.error){console.log("shell.js: internal error");console.log(g.stack||g);process.exit(1)}if(config.fatal){throw g}}state.currentCmd="shell.js";return h}}exports.wrap=wrap;