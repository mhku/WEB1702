var fs=require("fs");var path=require("path");var common=require("./common");var os=require("os");function copyFileSync(f,h){if(!fs.existsSync(f)){common.error("copyFileSync: no such file or directory: "+f)}var j=64*1024,b=new Buffer(j),a=j,i=0,d=null,c=null;try{d=fs.openSync(f,"r")}catch(g){common.error("copyFileSync: could not read src file ("+f+")")}try{c=fs.openSync(h,"w")}catch(g){common.error("copyFileSync: could not write to dest file (code="+g.code+"):"+h)}while(a===j){a=fs.readSync(d,b,0,j,i);fs.writeSync(c,b,0,a);i+=a}fs.closeSync(d);fs.closeSync(c);fs.chmodSync(h,fs.statSync(f).mode)}function cpdirSyncRecursive(m,d,b){if(!b){b={}}var f=fs.statSync(m);try{fs.mkdirSync(d,f.mode)}catch(j){if(j.code!=="EEXIST"){throw j}}var c=fs.readdirSync(m);for(var g=0;g<c.length;g++){var h=m+"/"+c[g];var k=d+"/"+c[g];var a=fs.lstatSync(h);if(a.isDirectory()){cpdirSyncRecursive(h,k,b)}else{if(a.isSymbolicLink()){var l=fs.readlinkSync(h);fs.symlinkSync(l,k,os.platform()==="win32"?"junction":null)}else{if(fs.existsSync(k)&&b.no_force){common.log("skipping existing file: "+c[g])}else{copyFileSync(h,k)}}}}}function _cp(c,b,a){c=common.parseOptions(c,{f:"!no_force",n:"no_force",R:"recursive",r:"recursive"});if(arguments.length<3){common.error("missing <source> and/or <dest>")}else{if(arguments.length>3){b=[].slice.call(arguments,1,arguments.length-1);a=arguments[arguments.length-1]}else{if(typeof b==="string"){b=[b]}else{if("length" in b){b=b}else{common.error("invalid arguments")}}}}var f=fs.existsSync(a),d=f&&fs.statSync(a);if((!f||!d.isDirectory())&&b.length>1){common.error("dest is not a directory (too many sources)")}if(f&&d.isFile()&&c.no_force){common.error("dest file already exists: "+a)}if(c.recursive){b.forEach(function(h,e){if(h[h.length-1]==="/"){b[e]+="*"}else{if(fs.statSync(h).isDirectory()&&!f){b[e]+="/*"}}});try{fs.mkdirSync(a,parseInt("0777",8))}catch(g){}}b=common.expand(b);b.forEach(function(l){if(!fs.existsSync(l)){common.error("no such file or directory: "+l,true);return}if(fs.statSync(l).isDirectory()){if(!c.recursive){common.log(l+" is a directory (not copied)")}else{var j=path.join(a,path.basename(l)),h=fs.statSync(l);try{fs.mkdirSync(j,h.mode)}catch(k){if(k.code!=="EEXIST"){common.error("dest file no such file or directory: "+j,true);throw k}}cpdirSyncRecursive(l,j,{no_force:c.no_force})}return}var i=a;if(fs.existsSync(a)&&fs.statSync(a).isDirectory()){i=path.normalize(a+"/"+path.basename(l))}if(fs.existsSync(i)&&c.no_force){common.error("dest file already exists: "+i,true);return}copyFileSync(l,i)})}module.exports=_cp;