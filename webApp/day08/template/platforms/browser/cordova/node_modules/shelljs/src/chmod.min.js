var common=require("./common");var fs=require("fs");var path=require("path");var PERMS=(function(a){return{OTHER_EXEC:a.EXEC,OTHER_WRITE:a.WRITE,OTHER_READ:a.READ,GROUP_EXEC:a.EXEC<<3,GROUP_WRITE:a.WRITE<<3,GROUP_READ:a.READ<<3,OWNER_EXEC:a.EXEC<<6,OWNER_WRITE:a.WRITE<<6,OWNER_READ:a.READ<<6,STICKY:parseInt("01000",8),SETGID:parseInt("02000",8),SETUID:parseInt("04000",8),TYPE_MASK:parseInt("0770000",8)}})({EXEC:1,WRITE:2,READ:4});function _chmod(a,e,f){if(!f){if(a.length>0&&a.charAt(0)==="-"){f=e;e=a;a=""}else{common.error("You must specify a file.")}}a=common.parseOptions(a,{R:"recursive",c:"changes",v:"verbose"});if(typeof f==="string"){f=[f]}var c;if(a.recursive){c=[];common.expand(f).forEach(function d(h){var g=fs.lstatSync(h);if(!g.isSymbolicLink()){c.push(h);if(g.isDirectory()){fs.readdirSync(h).forEach(function(i){d(h+"/"+i)})}}})}else{c=common.expand(f)}c.forEach(function b(h){h=path.resolve(h);if(!fs.existsSync(h)){common.error("File not found: "+h)}if(a.recursive&&fs.lstatSync(h).isSymbolicLink()){return}var k=fs.statSync(h);var l=k.isDirectory();var g=k.mode;var j=g&PERMS.TYPE_MASK;var i=g;if(isNaN(parseInt(e,8))){e.split(",").forEach(function(r){var v=/([ugoa]*)([=\+-])([rwxXst]*)/i;var s=v.exec(r);if(s){var o=s[1];var n=s[2];var x=s[3];var y=o.indexOf("u")!=-1||o==="a"||o==="";var u=o.indexOf("g")!=-1||o==="a"||o==="";var q=o.indexOf("o")!=-1||o==="a"||o==="";var p=x.indexOf("r")!=-1;var w=x.indexOf("w")!=-1;var t=x.indexOf("x")!=-1;var z=x.indexOf("X")!=-1;var m=x.indexOf("t")!=-1;var B=x.indexOf("s")!=-1;if(z&&l){t=true}var A=0;if(y){A|=(p?PERMS.OWNER_READ:0)+(w?PERMS.OWNER_WRITE:0)+(t?PERMS.OWNER_EXEC:0)+(B?PERMS.SETUID:0)}if(u){A|=(p?PERMS.GROUP_READ:0)+(w?PERMS.GROUP_WRITE:0)+(t?PERMS.GROUP_EXEC:0)+(B?PERMS.SETGID:0)}if(q){A|=(p?PERMS.OTHER_READ:0)+(w?PERMS.OTHER_WRITE:0)+(t?PERMS.OTHER_EXEC:0)}if(m){A|=PERMS.STICKY}switch(n){case"+":i|=A;break;case"-":i&=~A;break;case"=":i=j+A;if(fs.statSync(h).isDirectory()){i|=(PERMS.SETUID+PERMS.SETGID)&g}break}if(a.verbose){console.log(h+" -> "+i.toString(8))}if(g!=i){if(!a.verbose&&a.changes){console.log(h+" -> "+i.toString(8))}fs.chmodSync(h,i);g=i}}else{common.error("Invalid symbolic mode change: "+r)}})}else{i=j+parseInt(e,8);if(fs.statSync(h).isDirectory()){i|=(PERMS.SETUID+PERMS.SETGID)&g}fs.chmodSync(h,i)}})}module.exports=_chmod;