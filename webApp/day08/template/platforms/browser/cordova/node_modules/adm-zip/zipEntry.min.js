var Utils=require("./util"),Headers=require("./headers"),Constants=Utils.Constants,Methods=require("./methods");module.exports=function(j){var n=new Headers.EntryHeader(),m=new Buffer(0),f=new Buffer(0),h=false,e=null,g=new Buffer(0);function b(){if(!j||!Buffer.isBuffer(j)){return new Buffer(0)}n.loadDataHeaderFromBinary(j);return j.slice(n.realDataOffset,n.realDataOffset+n.compressedSize)}function l(o){if(n.flags&8!=8){if(Utils.crc32(o)!=n.crc){return false}}else{}return true}function a(p,t,q){if(typeof t==="undefined"&&typeof p==="string"){q=p;p=void 0}if(h){if(p&&t){t(new Buffer(0),Utils.Errors.DIRECTORY_CONTENT_ERROR)}return new Buffer(0)}var o=b();if(o.length==0){if(p&&t){t(o,Utils.Errors.NO_DATA)}return o}var r=new Buffer(n.size);r.fill(0);switch(n.method){case Utils.Constants.STORED:o.copy(r);if(!l(r)){if(p&&t){t(r,Utils.Errors.BAD_CRC)}return Utils.Errors.BAD_CRC}else{if(p&&t){t(r)}return r}break;case Utils.Constants.DEFLATED:var s=new Methods.Inflater(o);if(!p){s.inflate(r);if(!l(r)){console.warn(Utils.Errors.BAD_CRC+" "+m.toString())}return r}else{s.inflateAsync(function(u){u.copy(r,0);if(!l(r)){if(t){t(r,Utils.Errors.BAD_CRC)}}else{if(t){t(r)}}})}break;default:if(p&&t){t(new Buffer(0),Utils.Errors.UNKNOWN_METHOD)}return Utils.Errors.UNKNOWN_METHOD}}function d(p,s){if((!e||!e.length)&&Buffer.isBuffer(j)){if(p&&s){s(b())}return b()}if(e.length&&!h){var o;switch(n.method){case Utils.Constants.STORED:n.compressedSize=n.size;o=new Buffer(e.length);e.copy(o);if(p&&s){s(o)}return o;break;default:case Utils.Constants.DEFLATED:var q=new Methods.Deflater(e);if(!p){var r=q.deflate();n.compressedSize=r.length;return r}else{q.deflateAsync(function(t){o=new Buffer(t.length);n.compressedSize=t.length;t.copy(o);s&&s(o)})}q=null;break}}else{if(p&&s){s(new Buffer(0))}else{return new Buffer(0)}}}function c(o,p){return(o.readUInt32LE(p+4)<<4)+o.readUInt32LE(p)}function k(r){var s=0;var o,q,p;while(s<r.length){o=r.readUInt16LE(s);s+=2;q=r.readUInt16LE(s);s+=2;p=r.slice(s,s+q);s+=q;if(Constants.ID_ZIP64===o){i(p)}}}function i(q){var p,s,r,o;if(q.length>=Constants.EF_ZIP64_SCOMP){p=c(q,Constants.EF_ZIP64_SUNCOMP);if(n.size===Constants.EF_ZIP64_OR_32){n.size=p}}if(q.length>=Constants.EF_ZIP64_RHO){s=c(q,Constants.EF_ZIP64_SCOMP);if(n.compressedSize===Constants.EF_ZIP64_OR_32){n.compressedSize=s}}if(q.length>=Constants.EF_ZIP64_DSN){r=c(q,Constants.EF_ZIP64_RHO);if(n.offset===Constants.EF_ZIP64_OR_32){n.offset=r}}if(q.length>=Constants.EF_ZIP64_DSN+4){o=q.readUInt32LE(Constants.EF_ZIP64_DSN);if(n.diskNumStart===Constants.EF_ZIP64_OR_16){n.diskNumStart=o}}}return{get entryName(){return m.toString()},get rawEntryName(){return m},set entryName(p){m=Utils.toBuffer(p);var o=m[m.length-1];h=(o==47)||(o==92);n.fileNameLength=m.length},get extra(){return g},set extra(o){g=o;n.extraLength=o.length;k(o)},get comment(){return f.toString()},set comment(o){f=Utils.toBuffer(o);n.commentLength=f.length},get name(){var o=m.toString();return h?o.substr(o.length-1).split("/").pop():o.split("/").pop()},get isDirectory(){return h},getCompressedData:function(){return d(false,null)},getCompressedDataAsync:function(o){d(true,o)},setData:function(o){e=Utils.toBuffer(o);if(!h&&e.length){n.size=e.length;n.method=Utils.Constants.DEFLATED;n.crc=Utils.crc32(o)}else{n.method=Utils.Constants.STORED}},getData:function(o){return a(false,null,o)},getDataAsync:function(p,o){a(true,p,o)},set attr(o){n.attr=o},get attr(){return n.attr},set header(o){n.loadFromBinary(o)},get header(){return n},packHeader:function(){var o=n.entryHeaderToBinary();m.copy(o,Utils.Constants.CENHDR);if(n.extraLength){g.copy(o,Utils.Constants.CENHDR+m.length)}if(n.commentLength){f.copy(o,Utils.Constants.CENHDR+m.length+n.extraLength,f.length)}return o},toString:function(){return'{\n\t"entryName" : "'+m.toString()+'",\n\t"name" : "'+m.toString().split("/").pop()+'",\n\t"comment" : "'+f.toString()+'",\n\t"isDirectory" : '+h+',\n\t"header" : '+n.toString().replace(/\t/mg,"\t\t")+',\n\t"compressedData" : <'+(j&&j.length+" bytes buffer"||"null")+'>\n\t"data" : <'+(e&&e.length+" bytes buffer"||"null")+">\n}"}}};