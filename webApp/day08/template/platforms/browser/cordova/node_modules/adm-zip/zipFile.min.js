var ZipEntry=require("./zipEntry"),Headers=require("./headers"),Utils=require("./util");module.exports=function(k,d){var c=[],b={},g=new Buffer(0),a="",h=require("fs"),f=null,e=new Headers.MainHeader();if(d==Utils.Constants.FILE){a=k;f=h.readFileSync(a);j()}else{if(d==Utils.Constants.BUFFER){f=k;j()}else{}}function i(){b={};c=new Array(e.diskEntries);var l=e.offset;for(var n=0;n<c.length;n++){var m=l,o=new ZipEntry(f);o.header=f.slice(m,m+=Utils.Constants.CENHDR);o.entryName=f.slice(m,m+=o.header.fileNameLength);if(o.header.extraLength){o.extra=f.slice(m,m+=o.header.extraLength)}if(o.header.commentLength){o.comment=f.slice(m,m+o.header.commentLength)}l+=o.header.entryHeaderSize;c[n]=o;b[o.entryName]=o}}function j(){var m=f.length-Utils.Constants.ENDHDR,o=Math.max(0,m-65535),l=-1;for(m;m>=o;m--){if(f[m]!=80){continue}if(f.readUInt32LE(m)==Utils.Constants.ENDSIG){l=m;break}}if(!~l){throw Utils.Errors.INVALID_FORMAT}e.loadFromBinary(f.slice(l,l+Utils.Constants.ENDHDR));if(e.commentLength){g=f.slice(l+Utils.Constants.ENDHDR)}i()}return{get entries(){return c},get comment(){return g.toString()},set comment(l){e.commentLength=l.length;g=l},getEntry:function(l){return b[l]||null},setEntry:function(l){c.push(l);b[l.entryName]=l;e.totalEntries=c.length},deleteEntry:function(n){var m=b[n];if(m&&m.isDirectory){var l=this;this.getEntryChildren(m).forEach(function(o){if(o.entryName!=n){l.deleteEntry(o.entryName)}})}c.splice(c.indexOf(m),1);delete (b[n]);e.totalEntries=c.length},getEntryChildren:function(n){if(n.isDirectory){var o=[],m=n.entryName,l=m.length;c.forEach(function(p){if(p.entryName.substr(0,l)==m){o.push(p)}});return o}return[]},compressToBuffer:function(){if(c.length>1){c.sort(function(s,r){var u=s.entryName.toLowerCase();var t=r.entryName.toLowerCase();if(u<t){return -1}if(u>t){return 1}return 0})}var m=0,q=[],l=[],o=0;e.size=0;e.offset=0;c.forEach(function(v){v.header.offset=o;var t=v.getCompressedData();var s=v.header.dataHeaderToBinary();var r=new Buffer(v.entryName+v.extra.toString());var w=s.length+r.length+t.length;o+=w;q.push(s);q.push(r);q.push(t);var u=v.packHeader();l.push(u);e.size+=u.length;m+=(w+u.length)});m+=e.mainHeaderSize;e.offset=o;o=0;var p=new Buffer(m);q.forEach(function(r){r.copy(p,o);o+=r.length});l.forEach(function(r){r.copy(p,o);o+=r.length});var n=e.toBinary();if(g){g.copy(n,Utils.Constants.ENDHDR)}n.copy(p,o);return p},toAsyncBuffer:function(r,l,t,p){if(c.length>1){c.sort(function(v,u){var x=v.entryName.toLowerCase();var w=u.entryName.toLowerCase();if(x>w){return -1}if(x<w){return 1}return 0})}var s=0,o=[],q=[],m=0;e.size=0;e.offset=0;var n=function(x){var u=arguments.callee;var w;if(x.length){var w=x.pop();var v=w.entryName+w.extra.toString();if(t){t(v)}w.getCompressedDataAsync(function(A){if(p){p(v)}w.header.offset=m;var z=w.header.dataHeaderToBinary();var y=new Buffer(v);var D=z.length+y.length+A.length;m+=D;o.push(z);o.push(y);o.push(A);var C=w.packHeader();q.push(C);e.size+=C.length;s+=(D+C.length);if(x.length){u(x)}else{s+=e.mainHeaderSize;e.offset=m;m=0;var E=new Buffer(s);o.forEach(function(F){F.copy(E,m);m+=F.length});q.forEach(function(F){F.copy(E,m);m+=F.length});var B=e.toBinary();if(g){g.copy(B,Utils.Constants.ENDHDR)}B.copy(E,m);r(E)}})}};n(c)}}};