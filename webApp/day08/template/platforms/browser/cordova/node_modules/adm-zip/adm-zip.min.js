var fs=require("fs"),pth=require("path");fs.existsSync=fs.existsSync||pth.existsSync;var ZipEntry=require("./zipEntry"),ZipFile=require("./zipFile"),Utils=require("./util");module.exports=function(b){var d=undefined,c="";if(b&&typeof b==="string"){if(fs.existsSync(b)){c=b;d=new ZipFile(b,Utils.Constants.FILE)}else{throw Utils.Errors.INVALID_FILENAME}}else{if(b&&Buffer.isBuffer(b)){d=new ZipFile(b,Utils.Constants.BUFFER)}else{d=new ZipFile(null,Utils.Constants.NONE)}}function a(f){if(f&&d){var e;if(typeof f==="string"){e=d.getEntry(f)}if(typeof f==="object"&&f.entryName!=undefined&&f.header!=undefined){e=d.getEntry(f.entryName)}if(e){return e}}return null}return{readFile:function(f){var e=a(f);return e&&e.getData()||null},readFileAsync:function(f,g){var e=a(f);if(e){e.getDataAsync(g)}else{g(null,"getEntry failed for:"+f)}},readAsText:function(g,f){var e=a(g);if(e){var h=e.getData();if(h&&h.length){return h.toString(f||"utf8")}}return""},readAsTextAsync:function(g,h,f){var e=a(g);if(e){e.getDataAsync(function(i){if(i&&i.length){h(i.toString(f||"utf8"))}else{h("")}})}else{h("")}},deleteFile:function(f){var e=a(f);if(e){d.deleteEntry(e.entryName)}},addZipComment:function(e){d.comment=e},getZipComment:function(){return d.comment||""},addZipEntryComment:function(f,g){var e=a(f);if(e){e.comment=g}},getZipEntryComment:function(f){var e=a(f);if(e){return e.comment||""}return""},updateFile:function(g,f){var e=a(g);if(e){e.setData(f)}},addLocalFile:function(g,f,e){if(fs.existsSync(g)){if(f){f=f.split("\\").join("/");if(f.charAt(f.length-1)!="/"){f+="/"}}else{f=""}var h=g.split("\\").join("/").split("/").pop();if(e){this.addFile(f+e,fs.readFileSync(g),"",0)}else{this.addFile(f+h,fs.readFileSync(g),"",0)}}else{throw Utils.Errors.FILE_NOT_FOUND.replace("%s",g)}},addLocalFolder:function(i,h,g){if(g===undefined){g=function(){return true}}else{if(g instanceof RegExp){g=function(j){return function(k){return j.test(k)}}(g)}}if(h){h=h.split("\\").join("/");if(h.charAt(h.length-1)!="/"){h+="/"}}else{h=""}i=i.split("\\").join("/");i=pth.normalize(i);if(i.charAt(i.length-1)!="/"){i+="/"}if(fs.existsSync(i)){var f=Utils.findFiles(i),e=this;if(f.length){f.forEach(function(k){var j=k.split("\\").join("/").replace(new RegExp(i,"i"),"");if(g(j)){if(j.charAt(j.length-1)!=="/"){e.addFile(h+j,fs.readFileSync(k),"",0)}else{e.addFile(h+j,new Buffer(0),"",0)}}})}}else{throw Utils.Errors.FILE_NOT_FOUND.replace("%s",i)}},addFile:function(h,g,i,e){var f=new ZipEntry();f.entryName=h;f.comment=i||"";f.attr=e||438;if(f.isDirectory&&g.length){}f.setData(g);d.setEntry(f)},getEntries:function(){if(d){return d.entries}else{return[]}},getEntry:function(e){return a(e)},extractEntryTo:function(j,l,e,f){f=f||false;e=typeof e=="undefined"?true:e;var i=a(j);if(!i){throw Utils.Errors.NO_ENTRY}var k=pth.resolve(l,e?i.entryName:pth.basename(i.entryName));if(i.isDirectory){k=pth.resolve(k,"..");var g=d.getEntryChildren(i);g.forEach(function(n){if(n.isDirectory){return}var m=n.getData();if(!m){throw Utils.Errors.CANT_EXTRACT_FILE}Utils.writeFileTo(pth.resolve(l,e?n.entryName:n.entryName.substr(i.entryName.length)),m,f)});return true}var h=i.getData();if(!h){throw Utils.Errors.CANT_EXTRACT_FILE}if(fs.existsSync(k)&&!f){throw Utils.Errors.CANT_OVERRIDE}Utils.writeFileTo(k,h,f);return true},extractAllTo:function(f,e){e=e||false;if(!d){throw Utils.Errors.NO_ZIP}d.entries.forEach(function(h){if(h.isDirectory){Utils.makeDir(pth.resolve(f,h.entryName.toString()));return}var g=h.getData();if(!g){throw Utils.Errors.CANT_EXTRACT_FILE+"2"}Utils.writeFileTo(pth.resolve(f,h.entryName.toString()),g,e)})},extractAllToAsync:function(j,f,h){f=f||false;if(!d){h(new Error(Utils.Errors.NO_ZIP));return}var e=d.entries;var g=e.length;e.forEach(function(i){if(g<=0){return}if(i.isDirectory){Utils.makeDir(pth.resolve(j,i.entryName.toString()));if(--g==0){h(undefined)}return}i.getDataAsync(function(k){if(g<=0){return}if(!k){g=0;h(new Error(Utils.Errors.CANT_EXTRACT_FILE+"2"));return}Utils.writeFileToAsync(pth.resolve(j,i.entryName.toString()),k,f,function(l){if(g<=0){return}if(!l){g=0;h(new Error("Unable to write"));return}if(--g==0){h(undefined)}})})})},writeZip:function(g,h){if(arguments.length==1){if(typeof g=="function"){h=g;g=""}}if(!g&&c){g=c}if(!g){return}var f=d.compressToBuffer();if(f){var e=Utils.writeFileTo(g,f,true);if(typeof h=="function"){h(!e?new Error("failed"):null,"")}}},toBuffer:function(g,h,f,e){this.valueOf=2;if(typeof g=="function"){d.toAsyncBuffer(g,h,f,e);return null}return d.compressToBuffer()}}};