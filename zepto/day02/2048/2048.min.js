if(!Function.prototype.bind){Function.prototype.bind=function(c){var a=this;var b=Array.prototype.slice.call(arguments,1);return function(){a.apply(c,b.concat(Array.prototype.slice.call(arguments)))}}}function setWidthHeight(){var b=window.innerWidth;var a=window.innerHeight-$("#pid").height();base_margin_left=(1/21)*b;cell_width=4*base_margin_left;base_margin_top=(1/21)*a;cell_height=4*base_margin_top;$("#gridPanel").css({width:b,height:a});$(".grid").css({width:cell_width,height:cell_height});$(".cell").css({width:cell_width,height:cell_height});for(var d=0;d<4;d++){for(var g=0;g<4;g++){var e=base_margin_top*(d+1)+cell_height*d;var f=base_margin_left*(g+1)+cell_width*g;$('[id $="'+d+g+'"]').css({top:e,left:f})}}}function funcGet(a){return document.getElementById(a)}var game={data:[],RN:4,CN:4,score:0,top:0,state:1,RUNNING:1,GAMEOVER:0,PLAYING:2,init:function(){var d=[];var a=[];for(var b=0;b<this.RN;b++){for(var e=0;e<this.CN;e++){d.push('<div id="g'+b+e+'" class="grid"></div>');a.push('<div id="c'+b+e+'" class="cell"></div>')}}funcGet("gridPanel").innerHTML=d.join("")+a.join("");setWidthHeight()},start:function(){this.init();animation.init();for(var b=0;b<this.RN;b++){this.data.push([]);for(var d=0;d<this.CN;d++){this.data[b][d]=0}}this.score=0;funcGet("top").innerHTML=this.getTop();this.state=this.RUNNING;funcGet("gameOver").style.display="none";this.randomNum();this.randomNum();this.updateView();document.addEventListener("touchmove",function(c){c.preventDefault()},{passive:false});var a=$("#gridPanel");console.log(a);a.on("swipeLeft",function(){console.log("swipe to left");this.moveLeft()}.bind(this));a.on("swipeRight",function(){console.log("swipe to right");this.moveRight()}.bind(this));a.on("swipeUp",function(){console.log("swipe to up");this.moveUp()}.bind(this));a.on("swipeDown",function(){console.log("swipe to down");this.moveDown()}.bind(this));document.onkeydown=function(){if(this.state==this.RUNNING){var c=window.event||arguments[0];switch(c.keyCode){case 37:this.moveLeft();break;case 38:this.moveUp();break;case 39:this.moveRight();break;case 40:this.moveDown();break}}}.bind(this)},updateView:function(){for(var a=0;a<this.RN;a++){for(var f=0;f<this.CN;f++){var e=funcGet("c"+a+f);if(this.data[a][f]==0){e.innerHTML="";e.className="cell"}else{e.innerHTML=this.data[a][f];e.className="cell n"+this.data[a][f];var b=base_margin_top*(a+1)+cell_height*a;var d=base_margin_left*(f+1)+cell_width*f;console.log($('[id $= "'+a+f+'"]'));$('[id $= "'+a+f+'"]').css({top:b,left:d})}}}funcGet("score").innerHTML=this.score;if(this.isGameOver()){this.state=this.GAMEOVER;funcGet("finalScore").innerHTML=this.score;funcGet("gameOver").style.display="block";if(this.score>this.getTop()){this.setTop(this.score)}}},setTop:function(b){var a=new Date();a.setFullYear(a.getFullYear()+1);document.cookie="top="+b+";expires="+a.toGMTString()},getTop:function(){var a=parseInt(document.cookie.slice(4));return isNaN(a)?0:a},isGameOver:function(){for(var a=0;a<this.RN;a++){for(var b=0;b<this.CN;b++){if(this.data[a][b]==0){return false}else{if(b!=this.CN-1&&this.data[a][b]==this.data[a][b+1]){return false}else{if(a!=this.RN-1&&this.data[a][b]==this.data[a+1][b]){return false}}}}}return true},randomNum:function(){for(;;){var a=Math.floor(Math.random()*this.RN);var b=Math.floor(Math.random()*this.CN);if(this.data[a][b]==0){this.data[a][b]=Math.random()<0.5?2:4;break}}},move:function(a){var b=this.data.toString();a.call(this);var c=this.data.toString();if(b!=c){this.state=this.PLAYING;animation.start(function(){this.randomNum();this.updateView();this.state=this.RUNNING}.bind(this))}},moveLeft:function(){this.move(function(){for(var a=0;a<this.RN;a++){this.moveLeftInRow(a)}})},moveLeftInRow:function(a){for(var d=0;d<this.CN-1;d++){var b=this.getRightInRow(a,d);if(b==-1){break}else{if(this.data[a][d]==0){this.data[a][d]=this.data[a][b];this.data[a][b]=0;animation.addTask(funcGet("c"+a+b),a,b,a,d);d--}else{if(this.data[a][d]==this.data[a][b]){this.data[a][d]*=2;this.data[a][b]=0;this.score+=this.data[a][d];animation.addTask(funcGet("c"+a+b),a,b,a,d)}}}}},getRightInRow:function(a,d){for(var b=d+1;b<this.CN;b++){if(this.data[a][b]!=0){return b}}return -1},moveRight:function(){this.move(function(){for(var a=0;a<this.RN;a++){this.moveRightInRow(a)}})},moveRightInRow:function(a){for(var d=this.CN-1;d>0;d--){var b=this.getLeftInRow(a,d);if(b==-1){break}else{if(this.data[a][d]==0){this.data[a][d]=this.data[a][b];this.data[a][b]=0;animation.addTask(funcGet("c"+a+b),a,b,a,d);d++}else{if(this.data[a][d]==this.data[a][b]){this.data[a][d]*=2;this.data[a][b]=0;this.score+=this.data[a][d];animation.addTask(funcGet("c"+a+b),a,b,a,d)}}}}},getLeftInRow:function(a,d){for(var b=d-1;b>=0;b--){if(this.data[a][b]!=0){return b}}return -1},moveUp:function(){this.move(function(){for(var a=0;a<this.CN;this.moveUpInCol(a),a++){}})},moveUpInCol:function(d){for(var b=0;b<this.RN-1;b++){var a=this.getDownInCol(b,d);if(a==-1){break}else{if(this.data[b][d]==0){this.data[b][d]=this.data[a][d];this.data[a][d]=0;animation.addTask(funcGet("c"+a+d),a,d,b,d);b--}else{if(this.data[b][d]==this.data[a][d]){this.data[b][d]*=2;this.data[a][d]=0;this.score+=this.data[b][d];animation.addTask(funcGet("c"+a+d),a,d,b,d)}}}}},getDownInCol:function(b,d){for(var a=b+1;a<this.RN;a++){if(this.data[a][d]!=0){return a}}return -1},moveDown:function(){this.move(function(){for(var a=0;a<this.RN;this.moveDownInCol(a),a++){}})},moveDownInCol:function(d){for(var b=this.RN-1;b>0;b--){var a=this.getUpInCol(b,d);if(a==-1){break}else{if(this.data[b][d]==0){this.data[b][d]=this.data[a][d];this.data[a][d]=0;animation.addTask(funcGet("c"+a+d),a,d,b,d);b++}else{if(this.data[b][d]==this.data[a][d]){this.data[b][d]*=2;this.data[a][d]=0;this.score+=this.data[b][d];animation.addTask(funcGet("c"+a+d),a,d,b,d)}}}}},getUpInCol:function(b,d){for(var a=b-1;a>=0;a--){if(this.data[a][d]!=0){return a}}return -1}};window.onload=function(){game.start()};